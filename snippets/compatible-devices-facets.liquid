{%- assign manufacturer_filter = results.filters
  | where: 'param_name', 'filter.v.m.product_compatible_devices.manufacturers_metaobjects'
  | first
-%}

{%- assign devices_filter = results.filters
  | where: 'param_name', 'filter.v.m.product_compatible_devices.devices_metaobject'
  | first
-%}

<div class="compatible-devices-topbar">
  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      id="compatibleManufacturerSelect"
      class="facets__select select__select"
      data-filter-param="{{ manufacturer_filter.param_name }}"
      {% if manufacturer_filter == blank or manufacturer_filter.values.size == 0 %}disabled{% endif %}
    >
      <option value="" data-gid="">
        {{ 'products.facets.compatible_manufacturers' | t }}
      </option>
      {%- for filter_value in manufacturer_filter.values -%}
        <option
          value="{{ filter_value.value | escape }}"
          {%- if filter_value.active -%} selected{%- endif -%}
        >
          {{ filter_value.label | escape }}
        </option>
      {%- endfor -%}
    </select>
    {% render 'icon-caret' %}
  </div>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      id="compatibleDeviceSelect"
      class="facets__select select__select"
      data-filter-param="{{ devices_filter.param_name }}"
      {% if devices_filter == blank or devices_filter.values.size == 0 %}disabled{% endif %}
    >
      <option value="">
        {{ 'products.facets.compatible_devices' | t }}
      </option>
      {%- for filter_value in devices_filter.values -%}
        <option
          value="{{ filter_value.value | escape }}"
          {%- if filter_value.active -%} selected{%- endif -%}
        >
          {{ filter_value.label | escape }}
        </option>
      {%- endfor -%}
    </select>
    {% render 'icon-caret' %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const manufacturerSelect = document.getElementById('compatibleManufacturerSelect');
    const deviceSelect = document.getElementById('compatibleDeviceSelect');

    const facetForm =
      document.querySelector('form#FacetFiltersForm') ||
      document.querySelector('facet-filters-form form') ||
      document.querySelector('form[data-facet-form]') ||
      document.querySelector('form');

    if (!facetForm) return;

    const upsertHidden = (name, value) => {
      // smaž existující inputy s tímto name (single-select)
      facetForm.querySelectorAll(`input[type="hidden"][name="${CSS.escape(name)}"]`).forEach(el => el.remove());

      if (!value) return;

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      facetForm.appendChild(input);
    };

    const submitFacetForm = () => {
      // reset page
      const pageInput = facetForm.querySelector('input[name="page"]');
      if (pageInput) pageInput.remove();

      if (typeof facetForm.requestSubmit === 'function') facetForm.requestSubmit();
      else facetForm.submit();
    };

    if (manufacturerSelect) {
      manufacturerSelect.addEventListener('change', () => {
        const mParam = manufacturerSelect.dataset.filterParam;
        const mVal = manufacturerSelect.value;

        if (!mParam) return;

        upsertHidden(mParam, mVal);

        if (deviceSelect && deviceSelect.dataset.filterParam) {
          deviceSelect.value = '';
          upsertHidden(deviceSelect.dataset.filterParam, '');
        }

        submitFacetForm();
      });
    }

    if (deviceSelect) {
      deviceSelect.addEventListener('change', () => {
        const dParam = deviceSelect.dataset.filterParam;
        const dVal = deviceSelect.value;
        if (!dParam) return;

        upsertHidden(dParam, dVal);
        submitFacetForm();
      });
    }
  });
</script>