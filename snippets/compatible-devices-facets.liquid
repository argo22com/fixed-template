<div class="compatible-devices-facets facets facets-active-toolbar flex pt-2" data-compatible-facets>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      class="facets__select select__select"
      data-compatible-select="manufacturer"
      data-filter-param="{{ manufacturer_filter.param_name }}"
      {% if manufacturer_filter == blank or manufacturer_filter.values.size == 0 %}disabled{% endif %}
    >
      <option value="" data-gid="">
        {{ 'products.facets.compatible_manufacturers' | t }}
      </option>

      {%- if manufacturer_filter and manufacturer_filter.values.size > 0 -%}
        {%- for filter_value in manufacturer_filter.values -%}
          {%- assign manufacturer_label = filter_value.label -%}
          {%- if manufacturers_all -%}
            {%- for m in manufacturers_all -%}
              {%- if m.id == filter_value.value -%}
                {%- assign manufacturer_label = m.display_name | default: m.title | default: filter_value.label -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

          <option value="" data-gid="{{ filter_value.value | escape }}" {%- if filter_value.active -%} selected{%- endif -%}>
            {{ manufacturer_label | escape }}
          </option>
        {%- endfor -%}
      {%- endif -%}
    </select>

    {% render 'icon-caret' %}
  </div>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      class="facets__select select__select"
      data-compatible-select="device"
      data-filter-param="{{ devices_filter.param_name }}"
      {% if devices_filter == blank or devices_filter.values.size == 0 %}disabled{% endif %}
    >
      <option value="" data-gid="">
        {{ 'products.facets.compatible_devices' | t }}
      </option>

      {%- if devices_filter and devices_filter.values.size > 0 -%}
        {%- for filter_value in devices_filter.values -%}
          <option value="" data-gid="{{ filter_value.value | escape }}" {%- if filter_value.active -%} selected{%- endif -%}>
            {{ filter_value.label | escape }}
          </option>
        {%- endfor -%}
      {%- endif -%}
    </select>

    {% render 'icon-caret' %}
  </div>

</div>
<script>
(function () {
  function saveScroll() {
    const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    sessionStorage.setItem('facetsScrollPosition', String(scrollPosition));
  }

  function restoreScrollOnce() {
    const scrollPosition = sessionStorage.getItem('facetsScrollPosition');
    if (scrollPosition) {
      window.scrollTo(0, Number(scrollPosition));
      sessionStorage.removeItem('facetsScrollPosition');
    }
  }

  function handleSelectChange(selectEl) {
    saveScroll();

    const param = selectEl.dataset.filterParam;
    if (!param) return;

    const selected = selectEl.options[selectEl.selectedIndex];
    const gid = selected?.dataset?.gid || '';

    const url = new URL(window.location.href);

    // single-select: přepiš hodnotu parametru
    url.searchParams.delete(param);

    // pokud se mění výrobce, resetni device filtr
    if (selectEl.dataset.compatibleSelect === 'manufacturer') {
      const deviceSelect = document.querySelector('[data-compatible-select="device"][data-filter-param]');
      const deviceParam = deviceSelect?.dataset?.filterParam;
      if (deviceParam) url.searchParams.delete(deviceParam);
    }

    url.searchParams.delete('page');

    if (gid) url.searchParams.set(param, gid);

    window.location.assign(url.toString());
  }

  function wireCompatibleSelects(root = document) {
    // Event delegation: připojíme listener na wrapper, ne na konkrétní <select>
    root.querySelectorAll('[data-compatible-facets]').forEach((wrap) => {
      if (wrap.dataset.wired === '1') return;
      wrap.dataset.wired = '1';

      wrap.addEventListener('change', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLSelectElement)) return;
        if (!target.matches('[data-compatible-select][data-filter-param]')) return;
        handleSelectChange(target);
      });
    });
  }

  // 1) initial
  document.addEventListener('DOMContentLoaded', () => {
    wireCompatibleSelects(document);
    restoreScrollOnce();
  });

  // 2) Shopify section events (někdy přijdou)
  document.addEventListener('shopify:section:load', () => wireCompatibleSelects(document));
  document.addEventListener('shopify:section:reorder', () => wireCompatibleSelects(document));

  // 3) MutationObserver: Dawn po AJAX filtraci mění HTML -> znovu připoj wrapper
  const mo = new MutationObserver((mutations) => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (!(node instanceof HTMLElement)) continue;
        if (node.matches?.('[data-compatible-facets]') || node.querySelector?.('[data-compatible-facets]')) {
          wireCompatibleSelects(document);
          return;
        }
      }
    }
  });

  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>