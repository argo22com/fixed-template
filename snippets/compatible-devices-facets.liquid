{%- assign manufacturer_filter = results.filters
  | where: 'param_name', 'filter.v.m.product_compatible_devices.manufacturers_metaobjects'
  | first
-%}

{%- assign devices_filter = results.filters
  | where: 'param_name', 'filter.v.m.product_compatible_devices.devices_metaobject'
  | first
-%}

<div class="compatible-devices-topbar">
  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      id="compatibleManufacturerSelect"
      class="facets__select select__select"
      data-filter-param="{{ manufacturer_filter.param_name }}"
      {% if manufacturer_filter == blank or manufacturer_filter.values.size == 0 %}disabled{% endif %}
    >
      <option value="">
        {{ 'products.facets.compatible_manufacturers' | t }}
      </option>
      {%- for filter_value in manufacturer_filter.values -%}
        <option value="{{ filter_value.value | escape }}" {%- if filter_value.active -%} selected{%- endif -%}>
          {{ filter_value.label | escape }}
        </option>
      {%- endfor -%}
    </select>
    {% render 'icon-caret' %}
  </div>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      id="compatibleDeviceSelect"
      class="facets__select select__select"
      data-filter-param="{{ devices_filter.param_name }}"
      {% if devices_filter == blank or devices_filter.values.size == 0 %}disabled{% endif %}
    >
      <option value="">
        {{ 'products.facets.compatible_devices' | t }}
      </option>
      {%- for filter_value in devices_filter.values -%}
        <option value="{{ filter_value.value | escape }}" {%- if filter_value.active -%} selected{%- endif -%}>
          {{ filter_value.label | escape }}
        </option>
      {%- endfor -%}
    </select>
    {% render 'icon-caret' %}
  </div>
</div>
<script>
  (function () {
    function getFacetForms() {
      // Dawn / Shopify standard: <facet-filters-form> obsahuje form uvnitř
      const forms = [];

      document.querySelectorAll('facet-filters-form form').forEach(f => forms.push(f));

      // časté ID v Dawn (někdy víc instancí)
      document.querySelectorAll('form[id*="FacetFiltersForm"]').forEach(f => {
        if (!forms.includes(f)) forms.push(f);
      });

      // fallback: všechny formy, které obsahují filter.* inputy
      document.querySelectorAll('form').forEach(f => {
        if (forms.includes(f)) return;
        if (f.querySelector('[name^="filter."]')) forms.push(f);
      });

      return forms;
    }

    function upsertHidden(form, name, value) {
      // single-select: odstraň staré hiddeny stejného name
      form.querySelectorAll('input[type="hidden"][name="' + CSS.escape(name) + '"]').forEach(el => el.remove());
      if (!value) return;

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    }

    function submitForm(form) {
      // reset stránkování
      form.querySelectorAll('input[name="page"]').forEach(el => el.remove());

      // Dawn poslouchá na submit a dělá AJAX render; potřebujeme vyvolat submit event
      const evt = new Event('submit', { bubbles: true, cancelable: true });
      const prevented = !form.dispatchEvent(evt);

      // když to nikdo neodchytil, tak klasický submit
      if (!prevented) {
        if (typeof form.requestSubmit === 'function') form.requestSubmit();
        else form.submit();
      }
    }

    function fallbackNavigate(param, value, resetParam) {
      const url = new URL(window.location.href);
      url.searchParams.delete(param);
      url.searchParams.delete('page');
      if (resetParam) url.searchParams.delete(resetParam);
      if (value) url.searchParams.set(param, value);
      window.location.assign(url.toString());
    }

    function wire() {
      const manufacturerSelect = document.getElementById('compatibleManufacturerSelect');
      const deviceSelect = document.getElementById('compatibleDeviceSelect');
      if (!manufacturerSelect && !deviceSelect) return;

      const manufacturerParam = manufacturerSelect?.dataset?.filterParam || '';
      const deviceParam = deviceSelect?.dataset?.filterParam || '';

      const forms = getFacetForms();

      const applyToForms = (changedParam, changedValue, resetParam) => {
        if (!forms.length) {
          // když nenajdeme facety form, alespoň funguj URL přepisem
          fallbackNavigate(changedParam, changedValue, resetParam);
          return;
        }

        forms.forEach(form => {
          upsertHidden(form, changedParam, changedValue);

          // volitelný reset druhého filtru (výrobce -> reset zařízení)
          if (resetParam) {
            upsertHidden(form, resetParam, '');
          }

          submitForm(form);
        });
      };

      if (manufacturerSelect && manufacturerParam) {
        manufacturerSelect.addEventListener('change', () => {
          // reset device select UI
          if (deviceSelect) deviceSelect.value = '';
          applyToForms(manufacturerParam, manufacturerSelect.value, deviceParam);
        });
      }

      if (deviceSelect && deviceParam) {
        deviceSelect.addEventListener('change', () => {
          applyToForms(deviceParam, deviceSelect.value, '');
        });
      }
    }

    document.addEventListener('DOMContentLoaded', wire);
    document.addEventListener('shopify:section:load', wire);
  })();
</script>