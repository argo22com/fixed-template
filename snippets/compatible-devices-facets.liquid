<div class="compatible-devices-facets facets facets-active-toolbar flex pt-2" data-compatible-facets>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      class="facets__select select__select"
      data-compatible-select="manufacturer"
      data-filter-param="{{ manufacturer_filter.param_name }}"
    >
      <option value="" data-gid="">
        {{ 'products.facets.compatible_manufacturers' | t }}
      </option>

      {%- if manufacturer_filter and manufacturer_filter.values.size > 0 -%}
        {%- for filter_value in manufacturer_filter.values -%}
          {%- assign manufacturer_label = filter_value.label -%}

          {%- if manufacturers_all -%}
            {%- for m in manufacturers_all -%}
              {%- if m.id == filter_value.value -%}
                {%- assign manufacturer_label = m.display_name | default: m.title | default: filter_value.label -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

          <option
            value=""
            data-gid="{{ filter_value.value | escape }}"
            {%- if filter_value.active -%} selected{%- endif -%}
          >
            {{ manufacturer_label | escape }}
          </option>
        {%- endfor -%}
      {%- endif -%}
    </select>

    {% render 'icon-caret' %}
  </div>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      class="facets__select select__select"
      data-compatible-select="device"
      data-filter-param="{{ devices_filter.param_name }}"
    >
      <option value="" data-gid="">
        {{ 'products.facets.compatible_devices' | t }}
      </option>

      {%- if devices_filter and devices_filter.values.size > 0 -%}
        {%- for filter_value in devices_filter.values -%}
          <option
            value=""
            data-gid="{{ filter_value.value | escape }}"
            {%- if filter_value.active -%} selected{%- endif -%}
          >
            {{ filter_value.label | escape }}
          </option>
        {%- endfor -%}
      {%- endif -%}
    </select>

    {% render 'icon-caret' %}
  </div>

</div>

<script>
(function () {
  function saveScroll() {
    const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    sessionStorage.setItem('facetsScrollPosition', String(scrollPosition));
  }

  function restoreScrollOnce() {
    const scrollPosition = sessionStorage.getItem('facetsScrollPosition');
    if (scrollPosition) {
      window.scrollTo(0, Number(scrollPosition));
      sessionStorage.removeItem('facetsScrollPosition');
    }
  }

  function computeDisabled(selectEl) {
    // pokud má select jen placeholder (1 option), musí být disabled
    // pokud má víc než 1, je enabled
    const realOptions = selectEl.querySelectorAll('option').length;
    selectEl.disabled = realOptions <= 1;
  }

  function getParam(selectEl) {
    // když param_name při některém renderu není dostupný, fallback na hardcoded
    const p = selectEl.dataset.filterParam || '';
    if (p) return p;

    return selectEl.dataset.compatibleSelect === 'manufacturer'
      ? 'filter.v.m.product_compatible_devices.manufacturers_metaobjects'
      : 'filter.v.m.product_compatible_devices.devices_metaobject';
  }

  function getGid(selectEl) {
    const opt = selectEl.options[selectEl.selectedIndex];
    return opt?.dataset?.gid || '';
  }

  function applySingleSelect(selectEl) {
    saveScroll();

    const param = getParam(selectEl);
    if (!param) return;

    const gid = getGid(selectEl);

    const url = new URL(window.location.href);

    // vždy smaž existující hodnotu tohoto filtru
    url.searchParams.delete(param);

    // změna výrobce -> reset zařízení
    if (selectEl.dataset.compatibleSelect === 'manufacturer') {
      const deviceSelect = document.querySelector('[data-compatible-facets] select[data-compatible-select="device"]');
      const deviceParam = deviceSelect ? getParam(deviceSelect) : 'filter.v.m.product_compatible_devices.devices_metaobject';
      if (deviceParam) url.searchParams.delete(deviceParam);

      // resetni UI device selectu, pokud existuje
      if (deviceSelect) deviceSelect.selectedIndex = 0;
    }

    url.searchParams.delete('page');

    if (gid) url.searchParams.set(param, gid);

    window.location.assign(url.toString());
  }

  function wire(root = document) {
    root.querySelectorAll('[data-compatible-facets]').forEach((wrap) => {
      if (wrap.dataset.wired === '1') return;
      wrap.dataset.wired = '1';

      // nastav disabled/enabled podle skutečného obsahu options
      wrap.querySelectorAll('select[data-compatible-select]').forEach((sel) => {
        computeDisabled(sel);
      });

      // delegation handler (přežije re-render wrapperu)
      wrap.addEventListener('change', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLSelectElement)) return;
        if (!target.matches('select[data-compatible-select]')) return;
        if (target.disabled) return;
        applySingleSelect(target);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    wire(document);
    restoreScrollOnce();
  });

  // Dawn / Shopify section reload
  document.addEventListener('shopify:section:load', () => wire(document));
  document.addEventListener('shopify:section:reorder', () => wire(document));

  // AJAX re-render (facets) – hlídáme změny DOM
  const mo = new MutationObserver((mutations) => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (!(node instanceof HTMLElement)) continue;
        if (node.matches?.('[data-compatible-facets]') || node.querySelector?.('[data-compatible-facets]')) {
          // nový wrapper = znovu wire
          wire(document);
          return;
        }
      }
    }
  });

  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>