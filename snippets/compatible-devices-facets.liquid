<div class="compatible-devices-facets facets facets-active-toolbar flex pt-2" data-compatible-facets>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      class="facets__select select__select"
      data-compatible-select="manufacturer"
      data-filter-param="{{ manufacturer_filter.param_name }}"
      data-auto-disable="1"
    >
      <option value="" data-gid="">
        {{ 'products.facets.compatible_manufacturers' | t }}
      </option>

      {%- if manufacturer_filter and manufacturer_filter.values.size > 0 -%}
        {%- for filter_value in manufacturer_filter.values -%}
          <option value="" data-gid="{{ filter_value.value | escape }}" {%- if filter_value.active -%} selected{%- endif -%}>
            {{ filter_value.label | escape }}
          </option>
        {%- endfor -%}
      {%- endif -%}
    </select>

    {% render 'icon-caret' %}
  </div>

  <div class="compatible-devices-facet-filter select facets__filter">
    <select
      class="facets__select select__select"
      data-compatible-select="device"
      data-filter-param="{{ devices_filter.param_name }}"
      data-auto-disable="1"
    >
      <option value="" data-gid="">
        {{ 'products.facets.compatible_devices' | t }}
      </option>

      {%- if devices_filter and devices_filter.values.size > 0 -%}
        {%- for filter_value in devices_filter.values -%}
          <option value="" data-gid="{{ filter_value.value | escape }}" {%- if filter_value.active -%} selected{%- endif -%}>
            {{ filter_value.label | escape }}
          </option>
        {%- endfor -%}
      {%- endif -%}
    </select>

    {% render 'icon-caret' %}
  </div>

</div>

<script>
(function () {
  function saveScroll() {
    const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    sessionStorage.setItem('facetsScrollPosition', String(scrollPosition));
  }

  function restoreScrollOnce() {
    const scrollPosition = sessionStorage.getItem('facetsScrollPosition');
    if (scrollPosition) {
      window.scrollTo(0, Number(scrollPosition));
      sessionStorage.removeItem('facetsScrollPosition');
    }
  }

  function setDisabledState(selectEl) {
    if (!selectEl || selectEl.dataset.autoDisable !== '1') return;

    // reálná hodnota = option, která má data-gid (a není prázdná)
    const realCount = Array.from(selectEl.options).filter(o => (o.dataset && o.dataset.gid)).length;

    // placeholder je první option bez data-gid -> realCount >= 1 => enable
    selectEl.disabled = realCount === 0;
  }

  function enforceDisabledStates(root = document) {
    root.querySelectorAll('[data-compatible-facets] select[data-auto-disable="1"]').forEach(sel => {
      setDisabledState(sel);
      // přebít případné "disable během loadingu" ještě jednou po chvilce
      setTimeout(() => setDisabledState(sel), 0);
      setTimeout(() => setDisabledState(sel), 200);
    });
  }

  function handleSelectChange(selectEl) {
    saveScroll();

    const param = selectEl.dataset.filterParam;
    if (!param) return;

    const selected = selectEl.options[selectEl.selectedIndex];
    const gid = selected?.dataset?.gid || '';

    const url = new URL(window.location.href);

    url.searchParams.delete(param);

    // změna výrobce -> reset zařízení
    if (selectEl.dataset.compatibleSelect === 'manufacturer') {
      const deviceSelect = document.querySelector('[data-compatible-facets] select[data-compatible-select="device"][data-filter-param]');
      const deviceParam = deviceSelect?.dataset?.filterParam;
      if (deviceParam) url.searchParams.delete(deviceParam);
      if (deviceSelect) deviceSelect.selectedIndex = 0;
    }

    url.searchParams.delete('page');
    if (gid) url.searchParams.set(param, gid);

    window.location.assign(url.toString());
  }

  function wire(root = document) {
    root.querySelectorAll('[data-compatible-facets]').forEach((wrap) => {
      if (wrap.dataset.wired === '1') return;
      wrap.dataset.wired = '1';

      wrap.addEventListener('change', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLSelectElement)) return;
        if (!target.matches('select[data-compatible-select][data-filter-param]')) return;

        // pokaždé přepočti disabled těsně před použitím
        setDisabledState(target);
        if (target.disabled) return;

        handleSelectChange(target);
      });
    });

    enforceDisabledStates(root);
  }

  document.addEventListener('DOMContentLoaded', () => {
    wire(document);
    restoreScrollOnce();
  });

  document.addEventListener('shopify:section:load', () => wire(document));
  document.addEventListener('shopify:section:reorder', () => wire(document));

  // sleduj re-rendery (Dawn facety mění DOM)
  const mo = new MutationObserver((mutations) => {
    for (const m of mutations) {
      if (m.type !== 'childList') continue;

      // kdykoliv se něco přidá/změní, zkus znovu enforce disabled + případně wire nové wrappery
      // (je to levné – jen pár selectů)
      wire(document);
      return;
    }
  });

  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>