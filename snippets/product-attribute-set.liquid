{% comment %}
  Renders a list of product attributes from all assigned collections

  Accepts:
  - product: {Object}
{% endcomment %}

{% liquid
  assign attribute_names = ''
  assign attribute_keys = ''

  for raw_collection in product.collections
    assign collection = collections[raw_collection.handle]
    if collection == blank
      continue
    endif

    assign attribute_sets = collection.metafields.product_attributes.product_attribute_set.value
    if attribute_sets != blank
      for attribute_set in attribute_sets
        assign attributes = attribute_set.list.value
        if attributes != blank
          for attribute in attributes
            if attribute.metafield_key == blank or attribute_keys contains attribute.metafield_key
              continue
            endif
            assign attribute_names = attribute_names | append: attribute.display_name | append: '|'
            assign attribute_keys = attribute_keys | append: attribute.metafield_key | append: '|'
          endfor
        endif
      endfor
    endif
  endfor

  assign attribute_names = attribute_names | split: '|' | uniq
  assign attribute_keys = attribute_keys | split: '|' | uniq
  assign keys_length = attribute_keys.size | minus: 1
%}

{% if product != blank %}
  <div class="w100">
    <div class="grid">
      {% for i in (0..keys_length) %}
        {% liquid
          assign key = attribute_keys[i]
          assign name = attribute_names[i]
          assign attribute_metafield = product.metafields.product_attributes[key]
          if attribute_metafield == blank
            assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[key]
          endif
        %}
        {% if attribute_metafield and attribute_metafield.value %}
          <div class="grid__item">
            <h4 class="db font-heading-bold margin0 margin-bottom-1rem h5">{{ name }}</h4>
            <div class="rte">
              {% render 'metafield-display', attribute_metafield: attribute_metafield %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}