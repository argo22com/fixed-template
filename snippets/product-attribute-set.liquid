{% liquid
  assign attribute_names = ''
  assign attribute_keys  = ''

  if products != blank
    for product in products
      for collection in product.collections
        assign mf = collection.metafields.product_attributes.product_attribute_set
        if mf == blank
          continue
        endif

        assign attr_sets = blank
        if mf.value and mf.value.id
          assign attr_sets = mf.value | array
        endif
        if attr_sets == blank
          if mf.references and mf.references.size > 0
            assign attr_sets = mf.references
          elsif mf.value and mf.value != blank
            assign attr_sets = mf.value
          endif
        endif

        if attr_sets != blank
          for s in attr_sets
            assign set_obj = s.value | default: s
            if set_obj and set_obj.list
              assign attrs = set_obj.list
              if attrs.value
                assign attrs = attrs.value
              endif
              if attrs != blank
                for a in attrs
                  assign a_obj = a.value | default: a
                  if a_obj.metafield_key == blank
                    continue
                  endif
                  if attribute_keys contains a_obj.metafield_key
                    continue
                  endif
                  assign attribute_names = attribute_names | append: a_obj.display_name | append: '|'
                  assign attribute_keys  = attribute_keys  | append: a_obj.metafield_key | append: '|'
                endfor
              endif
            endif
          endfor
        endif
      endfor
    endfor

  elsif product != blank
    for collection in product.collections
      assign mf = collection.metafields.product_attributes.product_attribute_set
      if mf == blank
        continue
      endif

      assign attr_sets = blank
      if mf.value and mf.value.id
        assign attr_sets = mf.value | array
      endif
      if attr_sets == blank
        if mf.references and mf.references.size > 0
          assign attr_sets = mf.references
        elsif mf.value and mf.value != blank
          assign attr_sets = mf.value
        endif
      endif

      if attr_sets != blank
        for s in attr_sets
          assign set_obj = s.value | default: s
          if set_obj and set_obj.list
            assign attrs = set_obj.list
            if attrs.value
              assign attrs = attrs.value
            endif
            if attrs != blank
              for a in attrs
                assign a_obj = a.value | default: a
                if a_obj.metafield_key == blank
                  continue
                endif
                assign attribute_names = attribute_names | append: a_obj.display_name | append: '|'
                assign attribute_keys  = attribute_keys  | append: a_obj.metafield_key | append: '|'
              endfor
            endif
          endif
        endfor
      endif
    endfor
  endif

  assign attribute_names = attribute_names | split: '|' | uniq | reject: ''
  assign attribute_keys  = attribute_keys  | split: '|' | uniq | reject: ''
  assign keys_length = attribute_keys.size | minus: 1
%}

{% assign enable_debug = true %}
{% if enable_debug %}
  {% liquid
    assign dbg_product_id = 0
    assign dbg_product_handle = ''
    assign dbg_collections_count = 0
    if product != blank
      assign dbg_product_id = product.id
      assign dbg_product_handle = product.handle
      assign dbg_collections_count = product.collections.size
    endif
  %}
  {% capture __dbg %}
{
  "product_id": {{ dbg_product_id }},
  "product_handle": {{ dbg_product_handle | json }},
  "collections_count": {{ dbg_collections_count }},
  "attribute_names": {{ attribute_names | json }},
  "attribute_keys": {{ attribute_keys | json }},
  "keys_length": {{ keys_length }},
  "collections_dump":
  {% if product != blank %}
  [
    {% for collection in product.collections %}
      {% liquid
        assign mf = collection.metafields.product_attributes.product_attribute_set
        assign has_mf = false
        if mf != blank
          assign has_mf = true
        endif

        assign resolution = 'none'
        if has_mf and mf.value and mf.value.id
          assign resolution = 'single.value'
        endif
        if resolution == 'none' and has_mf and mf.references and mf.references.size > 0
          assign resolution = 'list.references'
        endif
        if resolution == 'none' and has_mf and mf.value and mf.value != blank
          assign resolution = 'list.value'
        endif

        assign sets_count = 0
        if resolution == 'single.value'
          assign sets_count = 1
        endif
        if resolution == 'list.references'
          assign sets_count = mf.references.size
        endif
        if resolution == 'list.value'
          assign sets_count = mf.value.size
        endif
      %}
      {
        "collection_id": {{ collection.id }},
        "collection_handle": {{ collection.handle | json }},
        "has_metafield": {{ has_mf | json }},
        "resolution": {{ resolution | json }},
        "sets_count": {{ sets_count }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  {% else %} null {% endif %}
}
  {% endcapture %}
  <details style="padding:12px;border:1px dashed #888;margin:10px 0" open>
    <summary><strong>DEBUG: product-attribute-set</strong></summary>
    <div style="font-family:ui-monospace, Menlo, monospace; font-size:13px; line-height:1.5">
      <pre>{{ __dbg | strip }}</pre>
    </div>
  </details>
{% endif %}

{% if products != blank %}
  {% for i in (0..keys_length) %}
    {% liquid
      assign all_empty = true
      for product in products
        if product.metafields.product_attributes
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
        else
          assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
        endif
        if attribute_metafield != blank and attribute_metafield.value != nil
          assign all_empty = false
          break
        endif
      endfor
    %}
    {% if all_empty == false %}
      <tr>
        <th>{{ attribute_names[i] }}:</th>
        {% for product in products %}
          {% if product.metafields.product_attributes %}
            {% assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]] %}
          {% else %}
            {% assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]] %}
          {% endif %}
          <td class="product-compare-{{ product.id }}">
            {% render 'metafield-display', attribute_metafield: attribute_metafield %}
          </td>
        {% endfor %}
      </tr>
    {% endif %}
  {% endfor %}
{% elsif product != blank %}
  <div class="w100">
    <div class="grid">
      {% for i in (0..keys_length)  %}
        {% liquid
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
          if attribute_metafield == blank
            assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
          endif
        %}
        {% if attribute_metafield != blank and attribute_metafield.value %}
          <div class="grid__item">
            <h4 class="db font-heading-bold margin0 margin-bottom-1rem h5">{{ attribute_names[i] }}</h4>
            <div class="rte">
              {% render 'metafield-display', attribute_metafield: attribute_metafield %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}
