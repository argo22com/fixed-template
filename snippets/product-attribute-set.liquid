{% assign __dbg_open = true %}
{% if __dbg_open %}
<div style="font-family:ui-monospace,monospace;font-size:12px;line-height:1.45;padding:12px;border:1px dashed #999;margin:12px 0;background:#fff">
<pre>{
  "product": {"id": {{ product.id }}, "handle": {{ product.handle | json }}, "variants": {{ product.variants.size }}},
  "collections": [
{% for c in product.collections %}
  {% assign mf = c.metafields.product_attributes.product_attribute_set %}
  {% assign sets = mf.references %}{% assign src = 'references' %}
  {% if sets == blank and mf.value != blank %}{% assign sets = mf.value %}{% assign src = 'value' %}{% endif %}
  {
    "handle": {{ c.handle | json }},
    "title": {{ c.title | json }},
    "sets_source": {{ src | json }},
    "sets_count": {% if sets != blank %}{{ sets.size | default: 1 }}{% else %}0{% endif %},
    "sets":[
      {% if sets != blank %}
        {% for s in sets %}
          {% assign so = s.value | default: s %}
          {% assign holder = so.list %}
          {% if holder == blank and so.product_attribute_set__list %}{% assign holder = so.product_attribute_set__list %}{% endif %}
          {% if holder == blank and so.product_attribute__list %}{% assign holder = so.product_attribute__list %}{% endif %}
          {% if holder == blank and so.attributes %}{% assign holder = so.attributes %}{% endif %}
          {% if holder == blank and so.attribute_list %}{% assign holder = so.attribute_list %}{% endif %}
          {% assign attrs = holder.references %}
          {% if attrs == blank and holder and holder.value %}{% assign attrs = holder.value %}{% endif %}
          {
            "set_name": {{ so.name | default: so.title | default: so.handle | default: so.id | json }},
            "attrs_count": {% if attrs != blank %}{{ attrs.size }}{% else %}0{% endif %},
            "attrs": [
              {% if attrs != blank %}
                {% for a0 in attrs %}
                  {% assign a = a0.value | default: a0 %}
                  {% assign k = a.metafield_key | default: a.product_attribute__metafield_key | default: a.key %}
                  {% if k != blank %}{% assign k = k | strip | replace: 'product_attributes.', '' %}{% if k contains '.' %}{% assign k = k | split: '.' | last %}{% endif %}{% endif %}
                  {% assign n = a.display_name | default: a.product_attribute__display_name | default: a.name %}
                  {"key": {{ k | json }}, "name": {{ n | json }}}{% unless forloop.last %},{% endunless %}
                {% endfor %}
              {% endif %}
            ]
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% endif %}
    ]
  }{% unless forloop.last %},{% endunless %}
{% endfor %}
  ],
  "gathered_keys": {{ attribute_keys | json }},
  "gathered_names": {{ attribute_names | json }},
  "product_keys": [{% for m in product.metafields.product_attributes %}{{ m[0] | json }}{% unless forloop.last %},{% endunless %}{% endfor %}],
  "variant_keys": [{% for m in product.selected_or_first_available_variant.metafields.product_attributes %}{{ m[0] | json }}{% unless forloop.last %},{% endunless %}{% endfor %}]
}
</pre>
</div>
{% endif %}