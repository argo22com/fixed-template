{% liquid
  assign attribute_names = ''
  assign attribute_keys  = ''

  if products != blank
    for product in products
      for collection in product.collections
        assign sets = collection.metafields.product_attributes.product_attribute_set.value
        if sets == blank
          continue
        endif

        if sets.id != blank
          assign attribute_sets = sets | array
        else
          assign attribute_sets = sets
        endif

        for attribute_set in attribute_sets
          assign set_obj = attribute_set.value | default: attribute_set
          assign attrs = set_obj.list
          if attrs and attrs.value
            assign attrs = attrs.value
          endif
          if attrs != blank
            for a in attrs
              assign a_obj = a.value | default: a
              if a_obj.metafield_key == blank
                continue
              endif
              if attribute_keys contains a_obj.metafield_key
                continue
              endif
              assign attribute_names = attribute_names | append: a_obj.display_name | append: '|'
              assign attribute_keys  = attribute_keys  | append: a_obj.metafield_key | append: '|'
            endfor
          endif
        endfor
      endfor
    endfor

  elsif product != blank
    for collection in product.collections
      assign sets = collection.metafields.product_attributes.product_attribute_set.value
      if sets == blank
        continue
      endif

      if sets.id != blank
        assign attribute_sets = sets | array
      else
        assign attribute_sets = sets
      endif

      for attribute_set in attribute_sets
        assign set_obj = attribute_set.value | default: attribute_set
        assign attrs = set_obj.list
        if attrs and attrs.value
          assign attrs = attrs.value
        endif
        if attrs != blank
          for a in attrs
            assign a_obj = a.value | default: a
            if a_obj.metafield_key == blank
              continue
            endif
            assign attribute_names = attribute_names | append: a_obj.display_name | append: '|'
            assign attribute_keys  = attribute_keys  | append: a_obj.metafield_key | append: '|'
          endfor
        endif
      endfor
    endfor
  endif

  assign attribute_names = attribute_names | split: '|' | uniq | reject: ''
  assign attribute_keys  = attribute_keys  | split: '|' | uniq | reject: ''
  assign keys_length = attribute_keys.size | minus: 1

  if product != blank and keys_length < 0
    assign fb_names = ''
    assign fb_keys  = ''

    assign pa = product.metafields.product_attributes
    if pa and pa != blank
      for mf in pa
        assign k = mf.key | default: mf[0]
        assign v = mf.value | default: mf[1]
        if k != blank and v != blank
          unless fb_keys contains k
            assign fb_keys  = fb_keys  | append: k | append: '|'
            assign fb_names = fb_names | append: k | append: '|'
          endunless
        endif
      endfor
    endif

    assign va = product.selected_or_first_available_variant.metafields.product_attributes
    if va and va != blank
      for mf in va
        assign k = mf.key | default: mf[0]
        assign v = mf.value | default: mf[1]
        if k != blank and v != blank
          unless fb_keys contains k
            assign fb_keys  = fb_keys  | append: k | append: '|'
            assign fb_names = fb_names | append: k | append: '|'
          endunless
        endif
      endfor
    endif

    assign attribute_keys  = fb_keys  | split: '|' | reject: ''
    assign attribute_names = fb_names | split: '|' | reject: ''
    assign keys_length = attribute_keys.size | minus: 1
  endif
%}

{% if products != blank %}
  {% for i in (0..keys_length) %}
    {% liquid
      assign all_empty = true
      for product in products
        if product.metafields.product_attributes
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
        else
          assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
        endif
        if attribute_metafield != blank and attribute_metafield.value != nil
          assign all_empty = false
          break
        endif
      endfor
    %}
    {% if all_empty == false %}
      <tr>
        <th>{{ attribute_names[i] }}:</th>
        {% for product in products %}
          {% if product.metafields.product_attributes %}
            {% assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]] %}
          {% else %}
            {% assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]] %}
          {% endif %}
          <td class="product-compare-{{ product.id }}">
            {% render 'metafield-display', attribute_metafield: attribute_metafield %}
          </td>
        {% endfor %}
      </tr>
    {% endif %}
  {% endfor %}
{% elsif product != blank %}
  <div class="w100">
    <div class="grid">
      {% for i in (0..keys_length)  %}
        {% liquid
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
          if attribute_metafield == blank
            assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
          endif
        %}
        {% if attribute_metafield != blank and attribute_metafield.value %}
          <div class="grid__item">
            <h4 class="db font-heading-bold margin0 margin-bottom-1rem h5">{{ attribute_names[i] }}</h4>
            <div class="rte">
              {% render 'metafield-display', attribute_metafield: attribute_metafield %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}
