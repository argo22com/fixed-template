{% comment %}
  Renders a list of product attributes

  Accepts:
  - products: {Array} Array of products to compare
  - product : {Object} Product to show

  Supports:
  - Single Attribute Set metaobject reference on a collection
  - List of Attribute Set metaobject references on a collection
  - Fallback: if no sets found, infer keys from product/variant metafields in namespace `product_attributes`

  Expected Product Attribute metaobject fields:
  - product_attribute.display_name
  - product_attribute.metafield_key
{% endcomment %}

{% assign attribute_names = '' %}
{% assign attribute_keys  = '' %}

{% assign enable_attribute_debug = false %}
{% if request.design_mode %}
  {% assign enable_attribute_debug = true %}
{% endif %}

{%- comment -%} === 1) COLLECT FROM COLLECTION ATTRIBUTE SETS (try .value and .reference(s)) === {%- endcomment -%}
{% assign collected_from_sets = false %}

{% assign _products = products | default: product | default: nil %}
{% if _products and _products != blank and _products.id %}
  {%- comment -%} single product given, wrap to array {%- endcomment -%}
  {% assign _products = _products | array %}
{% endif %}

{% if _products != blank %}
  {% for p in _products %}
    {% for collection in p.collections %}

      {%- assign set_mf = collection.metafields.product_attributes.product_attribute_set -%}
      {%- assign attribute_sets = blank -%}

      {%- comment -%} 1) Prefer .value if present (Liquid) {%- endcomment -%}
      {% if set_mf != blank and set_mf.value %}
        {% if set_mf.value.id %}
          {% assign attribute_sets = set_mf.value | array %}
        {% else %}
          {% assign attribute_sets = set_mf.value %}
        {% endif %}
      {% endif %}

      {%- comment -%} 2) If nothing, try .references/.reference {%- endcomment -%}
      {% if attribute_sets == blank and set_mf != blank %}
        {% if set_mf.type contains 'list' and set_mf.references %}
          {% assign attribute_sets = set_mf.references %}
        {% elsif set_mf.reference %}
          {% assign attribute_sets = set_mf.reference | array %}
        {% endif %}
      {% endif %}

      {% if attribute_sets != blank %}
        {% for attribute_set in attribute_sets %}
          {% assign set_obj = attribute_set.value | default: attribute_set %}

          {%- assign list_mf = set_obj.list -%}
          {%- assign attrs = blank -%}

          {%- comment -%} read list via .value first {%- endcomment -%}
          {% if list_mf and list_mf.value %}
            {% assign attrs = list_mf.value %}
          {% endif %}

          {%- comment -%} then try .references/.reference if still blank {%- endcomment -%}
          {% if attrs == blank and list_mf %}
            {% if list_mf.type and list_mf.type contains 'list' and list_mf.references %}
              {% assign attrs = list_mf.references %}
            {% elsif list_mf.reference %}
              {% assign attrs = list_mf.reference | array %}
            {% endif %}
          {% endif %}

          {% if attrs != blank %}
            {% for a0 in attrs %}
              {% assign a    = a0.value | default: a0 %}
              {% assign name = a['product_attribute.display_name'] | default: a.display_name | default: a.fields.display_name %}
              {% assign key  = a['product_attribute.metafield_key']  | default: a.metafield_key  | default: a.fields.metafield_key %}

              {% if key == blank %}
                {% continue %}
              {% endif %}

              {% unless attribute_keys contains key %}
                {% assign attribute_names = attribute_names | append: name | append: '|' %}
                {% assign attribute_keys  = attribute_keys  | append: key  | append: '|' %}
              {% endunless %}

              {% assign collected_from_sets = true %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      {% endif %}

    {% endfor %}
  {% endfor %}
{% endif %}

{%- comment -%} === 2) FALLBACK: infer keys from product/variant metafields === {%- endcomment -%}
{% assign collected_from_fallback = false %}

{% if collected_from_sets == false and product != blank %}
  {% assign pa = product.metafields.product_attributes %}
  {% if pa and pa != blank %}
    {% for mf in pa %}
      {% assign k = mf.key | default: mf[0] %}
      {% assign v = mf.value | default: mf[1] %}
      {% if v != blank and k != blank %}
        {% unless attribute_keys contains k %}
          {% assign attribute_keys  = attribute_keys  | append: k | append: '|' %}
          {% assign labelized = k | replace: '_', ' ' | replace: '-', ' ' %}
          {% assign attribute_names = attribute_names | append: labelized | append: '|' %}
          {% assign collected_from_fallback = true %}
        {% endunless %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% assign va = product.selected_or_first_available_variant.metafields.product_attributes %}
  {% if va and va != blank %}
    {% for mf in va %}
      {% assign k = mf.key | default: mf[0] %}
      {% assign v = mf.value | default: mf[1] %}
      {% if v != blank and k != blank %}
        {% unless attribute_keys contains k %}
          {% assign attribute_keys  = attribute_keys  | append: k | append: '|' %}
          {% assign labelized = k | replace: '_', ' ' | replace: '-', ' ' %}
          {% assign attribute_names = attribute_names | append: labelized | append: '|' %}
          {% assign collected_from_fallback = true %}
        {% endunless %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{%- comment -%} === Normalize & dedupe === {%- endcomment -%}
{% assign attribute_names = attribute_names | split: '|' | reject: '' | uniq %}
{% assign attribute_keys  = attribute_keys  | split: '|' | reject: '' | uniq %}
{% assign keys_length = attribute_keys.size | minus: 1 %}

{%- if enable_attribute_debug -%}
  {%- capture __dbg -%}
{
  "collected_from_sets": {{ collected_from_sets | json }},
  "collected_from_fallback": {{ collected_from_fallback | json }},
  "attribute_names": {{ attribute_names | json }},
  "attribute_keys": {{ attribute_keys | json }},
  "keys_length": {{ keys_length }}
}
  {%- endcapture -%}
  <details style="padding:12px;border:1px dashed #888;margin:10px 0" open>
    <summary><strong>DEBUG: product-attribute-set</strong></summary>
    <div style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px; line-height:1.5">
      <pre>{{ __dbg | strip }}</pre>
    </div>
  </details>
{%- endif -%}

{% if products != blank %}
  {% for i in (0..keys_length) %}
    {% liquid
      assign all_empty = true
      for p in products
        if p.metafields.product_attributes
          assign attribute_metafield = p.metafields.product_attributes[attribute_keys[i]]
        else
          assign attribute_metafield = p.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
        endif
        if attribute_metafield != blank and attribute_metafield.value != nil
          assign all_empty = false
          break
        endif
      endfor
    %}
    {% if all_empty == false %}
      <tr>
        <th>{{ attribute_names[i] }}:</th>
        {% for p in products %}
          {% if p.metafields.product_attributes %}
            {% assign attribute_metafield = p.metafields.product_attributes[attribute_keys[i]] %}
          {% else %}
            {% assign attribute_metafield = p.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]] %}
          {% endif %}
          <td class="product-compare-{{ p.id }}">
            {% render 'metafield-display', attribute_metafield: attribute_metafield %}
          </td>
        {% endfor %}
      </tr>
    {% endif %}
  {% endfor %}

{% elsif product != blank %}
  <div class="w100">
    <div class="grid">
      {% for i in (0..keys_length) %}
        {% liquid
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
          if attribute_metafield == blank
            assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
          endif
        %}
        {% if attribute_metafield != blank and attribute_metafield.value %}
          <div class="grid__item">
            <h4 class="db font-heading-bold margin0 margin-bottom-1rem h5">{{ attribute_names[i] }}</h4>
            <div class="rte">
              {% render 'metafield-display', attribute_metafield: attribute_metafield %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}