{% comment %}
  Renders product attributes from collection attribute sets (list of references)
  Accepts:
  - product: current product
  - collection: collection object passed manually (with metafields)
{% endcomment %}

{% liquid
  assign attribute_names = ''
  assign attribute_keys = ''

  if collection != blank and collection.metafields.product_attributes.product_attribute_set.value != blank
    assign attribute_sets = collection.metafields.product_attributes.product_attribute_set.value

    for attribute_set in attribute_sets
      if attribute_set.list.value != blank
        for attribute in attribute_set.list.value
          if attribute_keys contains attribute.metafield_key
            continue
          endif
          assign attribute_names = attribute_names | append: attribute.display_name | append: '|'
          assign attribute_keys = attribute_keys | append: attribute.metafield_key | append: '|'
        endfor
      endif
    endfor
  endif

  assign attribute_names = attribute_names | split: '|' | uniq
  assign attribute_keys = attribute_keys | split: '|' | uniq
  assign keys_length = attribute_keys.size | minus: 1
%}

{% if product != blank %}
  <div class="w100">
    <div class="grid">
      {% for i in (0..keys_length) %}
        {% liquid
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
          if attribute_metafield == blank
            assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
          endif
        %}
        {% if attribute_metafield and attribute_metafield.value %}
          <div class="grid__item">
            <h4 class="db font-heading-bold margin0 margin-bottom-1rem h5">{{ attribute_names[i] }}</h4>
            <div class="rte">
              {% render 'metafield-display', attribute_metafield: attribute_metafield %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}