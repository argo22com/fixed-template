{% comment %}
  Renders a list of product attributes

  Accepts:
  - products: {Array} Array of products to compare
  - product : {Object} Product to show

  Works with either:
  - Single Attribute Set metaobject reference on a collection, OR
  - A list of Attribute Set metaobject references on a collection

  Each Attribute Set metaobject is expected to have field:
  - list: (list of attribute metaobjects)
      - attribute.display_name
      - attribute.metafield_key

  Usage:
  {% render 'product-attribute-set', products: products %}
  {% render 'product-attribute-set', product: product %}
{% endcomment %}

{% liquid
  assign attribute_names = ''
  assign attribute_keys  = ''

  # Debug toggle
  assign enable_attribute_debug = false
  if request.design_mode
    assign enable_attribute_debug = true
  endif
%}

{% liquid
  # === COLLECT ATTRIBUTES FROM COLLECTION METAOBJECT SETS ===
  if products != blank
    for product in products
      for collection in product.collections
        assign sets = collection.metafields.product_attributes.product_attribute_set.value
        if sets == blank
          continue
        endif

        # Normalize: single → array
        if sets.id != blank
          assign attribute_sets = sets | array
        else
          assign attribute_sets = sets
        endif

        for attribute_set in attribute_sets
          if attribute_set.list and attribute_set.list.value
            for attribute in attribute_set.list.value
              if attribute_keys contains attribute.metafield_key
                continue
              endif
              assign attribute_names = attribute_names | append: attribute.display_name | append: '|'
              assign attribute_keys  = attribute_keys  | append: attribute.metafield_key | append: '|'
            endfor
          endif
        endfor
      endfor
    endfor

  elsif product != blank
    for collection in product.collections
      assign sets = collection.metafields.product_attributes.product_attribute_set.value
      if sets == blank
        continue
      endif

      # Normalize: single → array
      if sets.id != blank
        assign attribute_sets = sets | array
      else
        assign attribute_sets = sets
      endif

      for attribute_set in attribute_sets
        if attribute_set.list and attribute_set.list.value
          for attribute in attribute_set.list.value
            assign attribute_names = attribute_names | append: attribute.display_name | append: '|'
            assign attribute_keys  = attribute_keys  | append: attribute.metafield_key | append: '|'
          endfor
        endif
      endfor
    endfor
  endif

  assign attribute_names = attribute_names | split: '|' | uniq
  assign attribute_keys  = attribute_keys  | split: '|' | uniq

  assign keys_length = attribute_keys.size | minus: 1
%}

{%- if enable_attribute_debug -%}
  {%- capture __dbg -%}
  {
    "context": "{{ products != blank | default: false | json }}",
    "product_id": {{ product.id | default: 0 }},
    "product_handle": {{ product.handle | json }},
    "collections_count": {{ product.collections.size | default: 0 }},
    "attribute_names": {{ attribute_names | json }},
    "attribute_keys": {{ attribute_keys | json }},
    "keys_length": {{ keys_length }},
    "product_metafields.product_attributes": {{ product.metafields.product_attributes | json }},
    "variant_metafields.product_attributes": {{ product.selected_or_first_available_variant.metafields.product_attributes | json }},
    "collections_dump": [
      {%- for collection in product.collections -%}
        {%- assign sets = collection.metafields.product_attributes.product_attribute_set.value -%}
        {
          "collection_id": {{ collection.id }},
          "collection_handle": {{ collection.handle | json }},
          "raw_set_value_type": {{ sets.id | default: blank | json | default: '"array_or_blank"'}},
          "has_sets": {{ sets != blank | json }},
          "sets":
            {%- if sets == blank -%} null
            {%- else -%}
              {%- if sets.id != blank -%}
                [
                  {
                    "set_id": {{ sets.id | json }},
                    "set_handle": {{ sets.handle | json }},
                    "list_size": {{ sets.list.value.size | default: 0 }},
                    "attributes": [
                      {%- for a in sets.list.value -%}
                        {"key": {{ a.metafield_key | json }}, "name": {{ a.display_name | json }} }{% unless forloop.last %},{% endunless %}
                      {%- endfor -%}
                    ]
                  }
                ]
              {%- else -%}
                [
                  {%- for s in sets -%}
                    {
                      "set_id": {{ s.id | json }},
                      "set_handle": {{ s.handle | json }},
                      "list_size": {{ s.list.value.size | default: 0 }},
                      "attributes": [
                        {%- for a in s.list.value -%}
                          {"key": {{ a.metafield_key | json }}, "name": {{ a.display_name | json }} }{% unless forloop.last %},{% endunless %}
                        {%- endfor -%}
                      ]
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ]
              {%- endif -%}
            {%- endif -%}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ]
  }
  {%- endcapture -%}

  <details style="padding:12px;border:1px dashed #888;margin:10px 0" open>
    <summary><strong>DEBUG: product-attribute-set</strong></summary>
    <div style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px; line-height:1.5">
      <pre>{{ __dbg | strip }}</pre>
    </div>
  </details>

  <script>
    try {
      const dbg = {{ __dbg | strip }};
      console.log('DEBUG product-attribute-set', dbg);
    } catch(e) { console.warn('Debug JSON parse failed', e); }
  </script>
{%- endif -%}

{% if products != blank %}
  {% for i in (0..keys_length) %}
    {% liquid
      assign all_empty = true
      for product in products
        if product.metafields.product_attributes
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
        else
          assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
        endif

        if attribute_metafield != blank and attribute_metafield.value != nil
          assign all_empty = false
          break
        endif
      endfor
    %}
    {% if all_empty == false %}
      <tr>
        <th>{{ attribute_names[i] }}:</th>
        {% for product in products %}
          {% if product.metafields.product_attributes %}
            {% assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]] %}
          {% else %}
            {% assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]] %}
          {% endif %}
          <td class="product-compare-{{ product.id }}">
            {% render 'metafield-display', attribute_metafield: attribute_metafield %}
          </td>
        {% endfor %}
      </tr>
    {% endif %}
  {% endfor %}

{% elsif product != blank %}
  <div class="w100">
    <div class="grid">
      {% for i in (0..keys_length) %}
        {% liquid
          assign attribute_metafield = product.metafields.product_attributes[attribute_keys[i]]
          if attribute_metafield == blank
            assign attribute_metafield = product.selected_or_first_available_variant.metafields.product_attributes[attribute_keys[i]]
          endif
        %}
        {% if attribute_metafield != blank and attribute_metafield.value %}
          <div class="grid__item">
            <h4 class="db font-heading-bold margin0 margin-bottom-1rem h5">{{ attribute_names[i] }}</h4>
            <div class="rte">
              {% render 'metafield-display', attribute_metafield: attribute_metafield %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}
