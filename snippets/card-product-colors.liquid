{%- comment -%}
  Product card color swatches (GROUP + full debug)
  - Najde "color" option dle settings.color_name (case-insensitive, bere první z CSV)
  - Zkusí načíst grupu variation_products (value | default: raw metafield)
  - Vylistuje barvy: aktuální produkt (aktuální barva první) + sestry z grupy + zbytek aktuálního
  - Fallback: pokud grupa nedorazí, barvy přímo z variant (uniq)
  - Limit 5 + „+N“
{%- endcomment -%}

{%- assign color_candidates = settings.color_name | default: '' | downcase | split: ',' | map: 'strip' -%}
{%- assign found_color_name_actual = '' -%}

{%- for opt in card_product.options_with_values -%}
  {%- assign opt_down = opt.name | downcase | strip -%}
  {%- if color_candidates contains opt_down -%}
    {%- assign found_color_name_actual = opt.name -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- if found_color_name_actual == '' and card_product.options_with_values.size > 0 -%}
  {%- comment -%} Fallback: vezmi první option, ať se něco zobrazí {%- endcomment -%}
  {%- assign found_color_name_actual = card_product.options_with_values.first.name -%}
{%- endif -%}

{%- assign color_option = card_product.options_by_name[found_color_name_actual] -%}
{%- if color_option == blank -%}
  <!-- CARD-COLORS: color option "{{ found_color_name_actual }}" na card_product nenalezena -->
  {%- break -%}
{%- endif -%}

{%- assign color_attr   = 'option' | append: color_option.position -%}
{%- assign current_variant = card_product.selected_or_first_available_variant -%}
{%- assign current_color   = current_variant[color_attr] | default: color_option.values | first -%}
{%- assign current_color_key = current_color | downcase | strip -%}

{%- comment -%} Bezpečné načtení grupy (value | default) {%- endcomment -%}
{%- assign _mf = card_product.metafields.product_variants_grouping.variation_products -%}
{%- assign group_items = nil -%}
{%- if _mf != blank -%}
  {%- assign group_items = _mf.value | default: _mf -%}
{%- endif -%}
{%- assign used_group = false -%}
{%- if group_items and group_items.size > 0 -%}{%- assign used_group = true -%}{%- endif -%}

{%- comment -%} DEBUG hlavička {%- endcomment -%}
{%- assign _mf_json = _mf | json -%}
<!-- CARD-COLORS DEBUG
     product_id={{ card_product.id }}
     title="{{ card_product.title | escape }}"
     color_option_name="{{ found_color_name_actual }}"
     color_attr="{{ color_attr }}"
     current_color="{{ current_color }}"
     group_items_size={{ group_items.size | default: 0 }}
     raw_metafield={{ _mf_json | default: 'null' }}
-->
<script>
  try {
    console.log('CARD DEBUG', {
      product_id: {{ card_product.id }},
      title: {{ card_product.title | json }},
      color_option_name: {{ found_color_name_actual | json }},
      color_attr: {{ color_attr | json }},
      current_color: {{ current_color | json }},
      group_items_size: {{ group_items.size | default: 0 }},
      option_names: {{ card_product.options_with_values | map: 'name' | json }},
      option_values: {{ card_product.options_with_values | map: 'values' | json }},
      raw_metafield: {{ _mf | json }}
    });
  } catch(e) { console.warn('CARD DEBUG error', e); }
</script>

{%- assign SEP = '::' -%}{%- assign END = ';;' -%}
{%- assign unique_keys = '' -%}
{%- assign entries = '' -%}

{%- comment -%} 1) Aktuální produkt – aktuální barva první {%- endcomment -%}
{%- assign vset = card_product.variants | where: color_attr, current_color -%}
{%- assign v1 = vset | where: 'featured_image' | first | default: vset | first -%}
{%- assign key = current_color | downcase | strip -%}
{%- assign needle = '|' | append: key | append: '|' -%}
{%- unless unique_keys contains needle -%}
  {%- assign unique_keys = unique_keys | append: needle -%}

  {%- assign handle = 'color-code-' | append: current_color -%}
  {%- assign cm = shop.metaobjects.color_codes_hex[handle] -%}
  {%- assign label = current_color -%}
  {%- if cm -%}
    {%- assign label = cm.label | default: cm.search_words.value | first | default: cm.code | default: current_color -%}
  {%- endif -%}

  {%- assign srcset = '' -%}{%- assign img100 = '' -%}
  {%- if v1 and v1.featured_image != blank -%}
    {%- assign img = v1.featured_image -%}
    {%- if img.width >= 165 -%}{%- assign u165 = img | image_url: width: 165 -%}{%- assign srcset = srcset | append: u165 | append: ' 165w,' -%}{%- endif -%}
    {%- if img.width >= 360 -%}{%- assign u360 = img | image_url: width: 360 -%}{%- assign srcset = srcset | append: u360 | append: ' 360w,' -%}{%- endif -%}
    {%- if img.width >= 430 -%}{%- assign u450 = img | image_url: width: 450 -%}{%- assign srcset = srcset | append: u450 | append: ' 450w,' -%}{%- endif -%}
    {%- assign ufull = img | image_url -%}{%- assign srcset = srcset | append: ufull | append: ' ' | append: img.width | append: 'w' -%}
    {%- assign img100 = img | image_url: width: 100, height: 100, crop: 'center' -%}
  {%- endif -%}

  {%- assign mode = 'none' -%}{%- assign bgstyle = '' -%}{%- assign hexes = '' -%}
  {%- if cm and cm.image.value -%}
    {%- assign imgu = cm.image.value | image_url: width: 100, height: 100, crop: 'center' -%}
    {%- assign bgstyle = '--background-image:url(' | append: imgu | append: ');' -%}
    {%- assign mode = 'image' -%}
  {%- elsif cm and cm.color_hex_list.value and cm.color_hex_list.value.size > 0 -%}
    {%- assign mode = 'hexlist' -%}
    {%- assign hexes = cm.color_hex_list.value | join: ',' -%}
  {%- endif -%}

  {%- assign entries = entries
    | append: key | append: SEP
    | append: v1.url | append: SEP
    | append: label | append: SEP
    | append: srcset | append: SEP
    | append: mode | append: SEP
    | append: hexes | append: SEP
    | append: bgstyle | append: SEP
    | append: img100 | append: END
  -%}
{%- endunless -%}

{%- comment -%} 2) Sesterské produkty z grupy – projdi VŠECHNY jejich hodnoty barvy {%- endcomment -%}
{%- if used_group -%}
  {%- for gp in group_items -%}
    {%- assign gp_color_option = gp.options_by_name[found_color_name_actual] -%}
    {%- if gp_color_option == blank -%}
      <!-- CARD-COLORS DEBUG gp{{ forloop.index }}: nemá option "{{ found_color_name_actual }}" -->
      {%- continue -%}
    {%- endif -%}

    <!-- CARD-COLORS DEBUG gp{{ forloop.index }}: values="{{ gp_color_option.values | join: ', ' }}" -->

    {%- assign gp_attr = 'option' | append: gp_color_option.position -%}
    {%- for val in gp_color_option.values -%}
      {%- assign key = val | downcase | strip -%}
      {%- assign needle = '|' | append: key | append: '|' -%}
      {%- unless unique_keys contains needle -%}
        {%- assign vset = gp.variants | where: gp_attr, val -%}
        {%- assign v1 = vset | where: 'featured_image' | first | default: vset | first -%}

        {%- assign handle = 'color-code-' | append: val -%}
        {%- assign cm = shop.metaobjects.color_codes_hex[handle] -%}
        {%- assign label = val -%}
        {%- if cm -%}
          {%- assign label = cm.label | default: cm.search_words.value | first | default: cm.code | default: val -%}
        {%- endif -%}

        {%- assign srcset = '' -%}{%- assign img100 = '' -%}
        {%- if v1 and v1.featured_image != blank -%}
          {%- assign img = v1.featured_image -%}
          {%- if img.width >= 165 -%}{%- assign u165 = img | image_url: width: 165 -%}{%- assign srcset = srcset | append: u165 | append: ' 165w,' -%}{%- endif -%}
          {%- if img.width >= 360 -%}{%- assign u360 = img | image_url: width: 360 -%}{%- assign srcset = srcset | append: u360 | append: ' 360w,' -%}{%- endif -%}
          {%- if img.width >= 430 -%}{%- assign u450 = img | image_url: width: 450 -%}{%- assign srcset = srcset | append: u450 | append: ' 450w,' -%}{%- endif -%}
          {%- assign ufull = img | image_url -%}{%- assign srcset = srcset | append: ufull | append: ' ' | append: img.width | append: 'w' -%}
          {%- assign img100 = img | image_url: width: 100, height: 100, crop: 'center' -%}
        {%- endif -%}

        {%- assign mode = 'none' -%}{%- assign bgstyle = '' -%}{%- assign hexes = '' -%}
        {%- if cm and cm.image.value -%}
          {%- assign imgu = cm.image.value | image_url: width: 100, height: 100, crop: 'center' -%}
          {%- assign bgstyle = '--background-image:url(' | append: imgu | append: ');' -%}
          {%- assign mode = 'image' -%}
        {%- elsif cm and cm.color_hex_list.value and cm.color_hex_list.value.size > 0 -%}
          {%- assign mode = 'hexlist' -%}
          {%- assign hexes = cm.color_hex_list.value | join: ',' -%}
        {%- endif -%}

        {%- assign unique_keys = unique_keys | append: needle -%}
        {%- assign entries = entries
          | append: key | append: SEP
          | append: v1.url | append: SEP
          | append: label | append: SEP
          | append: srcset | append: SEP
          | append: mode | append: SEP
          | append: hexes | append: SEP
          | append: bgstyle | append: SEP
          | append: img100 | append: END
        -%}
      {%- endunless -%}
    {%- endfor -%}
  {%- endfor -%}
{%- endif -%}

{%- comment -%} 3) Zbývající barvy aktuálního produktu (které jsme ještě nepřidali) {%- endcomment -%}
{%- for val in color_option.values -%}
  {%- assign key = val | downcase | strip -%}
  {%- assign needle = '|' | append: key | append: '|' -%}
  {%- unless unique_keys contains needle -%}
    {%- assign vset = card_product.variants | where: color_attr, val -%}
    {%- assign v1 = vset | where: 'featured_image' | first | default: vset | first -%}

    {%- assign handle = 'color-code-' | append: val -%}
    {%- assign cm = shop.metaobjects.color_codes_hex[handle] -%}
    {%- assign label = val -%}
    {%- if cm -%}
      {%- assign label = cm.label | default: cm.search_words.value | first | default: cm.code | default: val -%}
    {%- endif -%}

    {%- assign srcset = '' -%}{%- assign img100 = '' -%}
    {%- if v1 and v1.featured_image != blank -%}
      {%- assign img = v1.featured_image -%}
      {%- if img.width >= 165 -%}{%- assign u165 = img | image_url: width: 165 -%}{%- assign srcset = srcset | append: u165 | append: ' 165w,' -%}{%- endif -%}
      {%- if img.width >= 360 -%}{%- assign u360 = img | image_url: width: 360 -%}{%- assign srcset = srcset | append: u360 | append: ' 360w,' -%}{%- endif -%}
      {%- if img.width >= 430 -%}{%- assign u450 = img | image_url: width: 450 -%}{%- assign srcset = srcset | append: u450 | append: ' 450w,' -%}{%- endif -%}
      {%- assign ufull = img | image_url -%}{%- assign srcset = srcset | append: ufull | append: ' ' | append: img.width | append: 'w' -%}
      {%- assign img100 = img | image_url: width: 100, height: 100, crop: 'center' -%}
    {%- endif -%}

    {%- assign mode = 'none' -%}{%- assign bgstyle = '' -%}{%- assign hexes = '' -%}
    {%- if cm and cm.image.value -%}
      {%- assign imgu = cm.image.value | image_url: width: 100, height: 100, crop: 'center' -%}
      {%- assign bgstyle = '--background-image:url(' | append: imgu | append: ');' -%}
      {%- assign mode = 'image' -%}
    {%- elsif cm and cm.color_hex_list.value and cm.color_hex_list.value.size > 0 -%}
      {%- assign mode = 'hexlist' -%}
      {%- assign hexes = cm.color_hex_list.value | join: ',' -%}
    {%- endif -%}

    {%- assign entries = entries
      | append: key | append: SEP
      | append: v1.url | append: SEP
      | append: label | append: SEP
      | append: srcset | append: SEP
      | append: mode | append: SEP
      | append: hexes | append: SEP
      | append: bgstyle | append: SEP
      | append: img100 | append: END
    -%}
  {%- endunless -%}
{%- endfor -%}

{%- comment -%} Pokud grupa nedala nic (nebo nebyla), FALLBACK: barvy přímo z variant {%- endcomment -%}
{%- assign items_tmp = entries | split: ';;' -%}
{%- assign nonempty = 0 -%}
{%- for it in items_tmp -%}{%- unless it == '' -%}{%- assign nonempty = nonempty | plus: 1 -%}{%- endunless -%}{%- endfor -%}
{%- if nonempty == 0 -%}
  <!-- CARD-COLORS DEBUG: GROUP EMPTY → FALLBACK VARIANTS -->
  {%- assign values = card_product.variants | map: color_attr | uniq -%}
  {%- assign ordered_values = '' -%}
  {%- for v in values -%}{%- if v == current_color -%}{%- assign ordered_values = ordered_values | append: v | append: '||' -%}{%- endif -%}{%- endfor -%}
  {%- for v in values -%}{%- unless v == current_color -%}{%- assign ordered_values = ordered_values | append: v | append: '||' -%}{%- endunless -%}{%- endfor -%}
  {%- assign values_ordered = ordered_values | split: '||' -%}
  {%- assign entries = '' -%}
  {%- assign unique_keys = '' -%}
  {%- for val in values_ordered -%}
    {%- unless val == '' -%}
      {%- assign key = val | downcase | strip -%}
      {%- assign needle = '|' | append: key | append: '|' -%}
      {%- unless unique_keys contains needle -%}
        {%- assign unique_keys = unique_keys | append: needle -%}
        {%- assign vset = card_product.variants | where: color_attr, val -%}
        {%- assign v1 = vset | where: 'featured_image' | first | default: vset | first -%}

        {%- assign handle = 'color-code-' | append: val -%}
        {%- assign cm = shop.metaobjects.color_codes_hex[handle] -%}
        {%- assign label = val -%}
        {%- if cm -%}
          {%- assign label = cm.label | default: cm.search_words.value | first | default: cm.code | default: val -%}
        {%- endif -%}

        {%- assign srcset = '' -%}{%- assign img100 = '' -%}
        {%- if v1 and v1.featured_image != blank -%}
          {%- assign img = v1.featured_image -%}
          {%- if img.width >= 165 -%}{%- assign u165 = img | image_url: width: 165 -%}{%- assign srcset = srcset | append: u165 | append: ' 165w,' -%}{%- endif -%}
          {%- if img.width >= 360 -%}{%- assign u360 = img | image_url: width: 360 -%}{%- assign srcset = srcset | append: u360 | append: ' 360w,' -%}{%- endif -%}
          {%- if img.width >= 430 -%}{%- assign u450 = img | image_url: width: 450 -%}{%- assign srcset = srcset | append: u450 | append: ' 450w,' -%}{%- endif -%}
          {%- assign ufull = img | image_url -%}{%- assign srcset = srcset | append: ufull | append: ' ' | append: img.width | append: 'w' -%}
          {%- assign img100 = img | image_url: width: 100, height: 100, crop: 'center' -%}
        {%- endif -%}

        {%- assign mode = 'none' -%}{%- assign bgstyle = '' -%}{%- assign hexes = '' -%}
        {%- if cm and cm.image.value -%}
          {%- assign imgu = cm.image.value | image_url: width: 100, height: 100, crop: 'center' -%}
          {%- assign bgstyle = '--background-image:url(' | append: imgu | append: ');' -%}
          {%- assign mode = 'image' -%}
        {%- elsif cm and cm.color_hex_list.value and cm.color_hex_list.value.size > 0 -%}
          {%- assign mode = 'hexlist' -%}
          {%- assign hexes = cm.color_hex_list.value | join: ',' -%}
        {%- endif -%}

        {%- assign entries = entries
          | append: key | append: SEP
          | append: v1.url | append: SEP
          | append: label | append: SEP
          | append: srcset | append: SEP
          | append: mode | append: SEP
          | append: hexes | append: SEP
          | append: bgstyle | append: SEP
          | append: img100 | append: END
        -%}
      {%- endunless -%}
    {%- endunless -%}
  {%- endfor -%}
{%- endif -%}

{%- comment -%} Render {%- endcomment -%}
<card-product-colors>
  <ul class="card__product-color-list list-unstyled flex flex-wrap align-center">
    {%- assign items = entries | split: ';;' -%}
    {%- assign total = 0 -%}
    {%- for it in items -%}{%- unless it == '' -%}{%- assign total = total | plus: 1 -%}{%- endunless -%}{%- endfor -%}
    <!-- CARD-COLORS DEBUG total={{ total }} -->
    {%- assign rendered = 0 -%}
    {%- for it in items -%}
      {%- unless it == '' -%}
        {%- assign p = it | split: '::' -%}
        {%- assign _key = p[0] -%}
        {%- assign _url = p[1] -%}
        {%- assign _title = p[2] -%}
        {%- assign _srcset = p[3] -%}
        {%- assign _mode = p[4] -%}
        {%- assign _hexes = p[5] -%}
        {%- assign _bgstyle = p[6] -%}
        {%- assign _img100 = p[7] -%}
        <li>
          <a href="{{ _url }}"
             class="card__product-color-list__button bt-tooltip por db{% if color_swatches_style == 'variant' %} card__product-color-list__button--variant{% endif %}"
             {% if _srcset != '' %}data-srcset="{{ _srcset }}"{% endif %}
             data-color="{{ _key | handleize }}"
             {% if _mode == 'image' and _bgstyle != '' %} style="{{ _bgstyle }}"{% endif %}>
            {%- if color_swatches_style == 'variant' and _img100 != '' -%}
              <img src="{{ _img100 }}" width="100" height="100" loading="lazy" class="w100 h100" alt="{{ card_product.title | escape }} - {{ _title }}"/>
            {%- elsif _mode == 'hexlist' and _hexes != '' -%}
              {%- assign color_list = _hexes | split: ',' -%}
              {%- assign color_size = color_list.size -%}
              <div class="color-swatch-background">
                {%- if color_size == 1 -%}
                  <span style="background: {{ color_list[0] }}; width: 100%; height: 100%"></span>
                {%- elsif color_size == 2 -%}
                  <span style="background: {{ color_list[0] }}; width: 100%; height: 100%; left: -50%"></span>
                  <span style="background: {{ color_list[1] }}; width: 100%; height: 100%; left: 50%"></span>
                {%- else -%}
                  {%- assign angle = 360 | divided_by: color_size -%}
                  {%- for c in color_list -%}
                    {%- assign rotation = angle | times: forloop.index0 -%}
                    {%- assign skew = -90 | plus: angle -%}
                    <span style="background: {{ c }}; transform: rotate({{ rotation }}deg) skew({{ skew }}deg);{% if color_size == 3 %}top:-10%; right:-25%; height:70%; width:70%{% endif %}"></span>
                  {%- endfor -%}
                {%- endif -%}
              </div>
            {%- endif -%}
            <span class="bt-tooltip__inner bt-tooltip__inner--top">{{ _title }}</span>
          </a>
        </li>
        {%- assign rendered = rendered | plus: 1 -%}
        {%- if rendered == 5 -%}{%- break -%}{%- endif -%}
      {%- endunless -%}
    {%- endfor -%}
    {%- if total > 5 -%}
      <li>
        <a href="{{ card_product.url }}" class="card__product-color-list__more lh1 font-body-bold{% if color_swatches_style == 'variant' %} card__product-color-list__more--variant flex justify-center align-center{% endif %}">
          +{{ total | minus: 5 }}
        </a>
      </li>
    {%- endif -%}
  </ul>
</card-product-colors>