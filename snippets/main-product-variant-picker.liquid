{%- unless product.has_only_default_variant -%}
  {%- liquid
    assign DEBUG = true
    assign max_rows = 4
    assign items_per_row = 3
    assign total_visible_items = max_rows | times: items_per_row

    assign current_variant = product.selected_or_first_available_variant
    assign first_selected_variant = current_variant | default: product.variants[0]

    assign variation_products = nil
    if product.metafields.product_variants_grouping and product.metafields.product_variants_grouping.variation_products
      assign variation_products = product.metafields.product_variants_grouping.variation_products.value
    endif
    if variation_products == nil or variation_products == empty
      if product.metafields['product_variants_grouping'] and product.metafields['product_variants_grouping']['variation_products']
        assign variation_products = product.metafields['product_variants_grouping']['variation_products'].value
      endif
    endif
    if variation_products == nil
      assign variation_products = '' | split: '|'
    endif

    assign color_name = 'UNIV_BARVA'
    assign color_key_exact = color_name
    assign color_key_up = color_name | upcase
    assign color_key_low = color_name | downcase

    assign option_color_position = null
    for option in product.options_with_values
      if option.name == color_key_exact
        assign option_color_position = 'option' | append: option.position
      elsif option.name == color_key_up
        assign option_color_position = 'option' | append: option.position
      elsif option.name == color_key_low
        assign option_color_position = 'option' | append: option.position
      endif
    endfor
  -%}

  <style>
    .variant-flex-item{flex:1 0 calc(100% * (1 /{{items_per_row}}) - 2rem);max-width:calc(100% * (1 /{{items_per_row}}) - 1rem)}
    .hidden-more{display:none!important}
    .dbg{font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;color:#222;background:#fff7d6;padding:.5rem .75rem;margin:.5rem 0;border:1px dashed #e6c200;border-radius:.25rem}
    .dbg .row{margin:.15rem 0}
    .dbg ul{margin:.25rem 0 0 .75rem}
    .dbg code{background:transparent;padding:0}
  </style>

  {%- if DEBUG -%}
    <div class="dbg">
      <div class="row">DEBUG ON</div>
      <div class="row">product.id: <code>{{ product.id }}</code></div>
      <div class="row">product.handle: <code>{{ product.handle }}</code></div>
      <div class="row">current_variant.id: <code>{{ current_variant.id }}</code></div>
      <div class="row">color_name: <code>{{ color_name }}</code></div>
      <div class="row">color_key_exact: <code>{{ color_key_exact }}</code> • color_key_up: <code>{{ color_key_up }}</code> • color_key_low: <code>{{ color_key_low }}</code></div>
      <div class="row">option_color_position: <code>{{ option_color_position | default: 'nil' }}</code></div>
      <div class="row">variation_products.size: <code>{{ variation_products.size | default: 0 }}</code></div>
      {%- if variation_products and variation_products.size > 0 -%}
        <ul>
          {%- for pv in variation_products -%}
            <li class="row">
              <div>pv.id: <code>{{ pv.id }}</code> • pv.handle: <code>{{ pv.handle }}</code></div>
              <div>pv.title: <code>{{ pv.title }}</code></div>
              <div>pv.options: <code>{{ pv.options | json }}</code></div>
              <div>has options_by_name[exact]: <code>{% if pv.options_by_name and pv.options_by_name[color_key_exact] %}true{% else %}false{% endif %}</code></div>
              <div>has options_by_name[up]: <code>{% if pv.options_by_name and pv.options_by_name[color_key_up] %}true{% else %}false{% endif %}</code></div>
              <div>has options_by_name[low]: <code>{% if pv.options_by_name and pv.options_by_name[color_key_low] %}true{% else %}false{% endif %}</code></div>
              {%- assign pv_color_dbg = '' -%}
              {%- if pv.options_by_name and pv.options_by_name[color_key_exact] -%}
                {%- assign pv_color_dbg = pv.options_by_name[color_key_exact].values | first -%}
              {%- elsif pv.options_by_name and pv.options_by_name[color_key_up] -%}
                {%- assign pv_color_dbg = pv.options_by_name[color_key_up].values | first -%}
              {%- elsif pv.options_by_name and pv.options_by_name[color_key_low] -%}
                {%- assign pv_color_dbg = pv.options_by_name[color_key_low].values | first -%}
              {%- endif -%}
              <div>pv UNIV_BARVA value: <code>{{ pv_color_dbg | default: 'nil' }}</code></div>
              <div>pv.variants.size: <code>{{ pv.variants.size }}</code></div>
              <ul>
                {%- for v in pv.variants -%}
                  <li><code>{{ v.id }}</code> • title: <code>{{ v.title }}</code> • o1: <code>{{ v.option1 }}</code> • o2: <code>{{ v.option2 }}</code> • o3: <code>{{ v.option3 }}</code> • mf.title: <code>{{ v.metafields.product_texts.title.value }}</code></li>
                {%- endfor -%}
              </ul>
            </li>
          {%- endfor -%}
        </ul>
      {%- endif -%}
    </div>
  {%- endif -%}

  {%- if block.settings.picker_type == 'button' and block.settings.enable_color_swatches -%}
    <link rel="stylesheet" href="{{ 'component-tooltip.css' | asset_url }}" media="print" onload="this.media='all'">
    <noscript>{{ 'component-tooltip.css' | asset_url | stylesheet_tag }}</noscript>
  {%- endif -%}

  {% for option in product.options_with_values %}
    {% assign values_count = option.values | size %}
    {% if option.name == 'default_option' and values_count == 1 %}
      {% continue %}
    {% endif %}

    {%- if option.name == 'default' -%}
      {%- continue -%}
    {%- elsif block.settings.picker_type == 'button' and option.name != settings.phone_name -%}
      {%- liquid
        unless settings.hide_unavailable_options
          assign instock_variants = product.variants | where: 'available'
        endunless
      -%}
      <{{ prefix_variant }}variant-radios
        class="no-js-hidden variant-picker-primary-{{ section.id }} db"
        data-section="{{ section.id }}"
        data-url="{{ product_url | default: product.url }}"
        {% if settings.hide_unavailable_options %}data-hide-unavailable-options="true"{% endif %}
      >
        {%- liquid
          assign is_color_swatches = false
          if option.name == color_key_exact or option.name == color_key_up or option.name == color_key_low
            if block.settings.enable_color_swatches
              assign is_color_swatches = true
            endif
          endif

          assign attribute = 'option' | append: forloop.index

          assign available_variants = product.variants
          unless settings.hide_unavailable_options
            assign instock_option_values = instock_variants
            assign position_checking = option.position | minus: 1
            for i in (1..position_checking)
              assign option_index = 'option' | append: i
              assign current_option_value = current_variant[option_index]
              assign instock_option_values = instock_option_values | where: option_index, current_option_value
            endfor
            assign instock_option_values = instock_option_values | map: attribute
            for available_option in product.options
              if option.position != forloop.index
                assign filter_index = 'option' | append: forloop.index
                assign filter_value = first_selected_variant[filter_index]
                assign available_variants = available_variants | where: filter_index, filter_value
              endif
            endfor
          else
            if option.position > 1
              assign end_compare_index = option.position | minus: 1
              for i in (1..end_compare_index)
                assign filter_index = 'option' | append: i
                assign filter_value = first_selected_variant[filter_index]
                assign available_variants = available_variants | where: filter_index, filter_value
              endfor
            endif
            assign instock_option_values = available_variants | where: 'available' | map: attribute
          endunless

          assign index_option = 'option' | append: option.position
          assign available_option_values = available_variants | map: index_option
        -%}

        <fieldset class="js js-product-form-input product-form__input product-form__input--fieldset flex flex-column{% unless forloop.first %} element-small-margin-top{% endunless %}">
          <legend class="product-form__input__form-label text-small margin-bottom-1rem">
            {{ option.name | capitalize }}:
            {% if is_color_swatches %}
              {% assign selected_code = option.selected_value | strip %}
              {% assign color_mo = nil %}
              {% assign color_list = shop.metaobjects.color_codes_hex.values %}
              {% if color_list %}
                {% for mo in color_list %}
                  {% if mo.code and mo.code.value == selected_code %}
                    {% assign color_mo = mo %}
                    {% break %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              <span class="product-form__input__option-value font-body-bold">
                {% if color_mo and color_mo.search_words and color_mo.search_words.value %}
                  {{ color_mo.search_words.value | first | capitalize }}
                {% else %}
                  {{ selected_code }}
                {% endif %}
              </span>
            {% else %}
              <span class="product-form__input__option-value font-body-bold">{{ option.selected_value }}</span>
            {% endif %}
          </legend>

          <ul class="list-unstyled flex flex-wrap product-form__input__radio-list{% if is_color_swatches %} product-form__input__radio-list--color{% endif %}">
            {%- for value in option.values -%}
              {% liquid
                assign is_first_option = forloop.first

                assign out_of_stock = false
                if settings.hide_unavailable_options
                  unless instock_option_values contains value
                    assign out_of_stock = true
                  endunless
                elsif available_option_values contains value
                  unless instock_option_values contains value
                    assign out_of_stock = true
                  endunless
                endif
              %}
              {%- assign variant = product.variants | where: attribute, value | first -%}
              {%- if is_color_swatches and block.settings.color_swatches_style == 'variant' -%}
                {%- assign variant_color = product.variants | where: attribute, value | where: 'featured_image' | first -%}
                {%- if variant_color == nil -%}
                  {%- assign variant_color = product.variants | where: attribute, value | first -%}
                {%- endif -%}
              {%- endif -%}

              {%- if is_color_swatches -%}
                {%- liquid
                  assign has_group = false
                  if variation_products and variation_products.size > 0
                    assign has_group = true
                  endif
                -%}

                {%- if has_group -%}
                  {%- for product_variation in variation_products -%}
                    {%- liquid
                      assign pv_color_value = ''
                      if product_variation.options_by_name and product_variation.options_by_name[color_key_exact]
                        assign pv_color_value = product_variation.options_by_name[color_key_exact].values | first
                      elsif product_variation.options_by_name and product_variation.options_by_name[color_key_up]
                        assign pv_color_value = product_variation.options_by_name[color_key_up].values | first
                      elsif product_variation.options_by_name and product_variation.options_by_name[color_key_low]
                        assign pv_color_value = product_variation.options_by_name[color_key_low].values | first
                      endif

                      assign product_current_variation = product_variation
                      assign product_variation_variants = product_variation.variants
                      for option2 in product.options_with_values
                        assign option_index = 'option' | append: option2.position
                        if option_index == option_color_position
                          continue
                        endif
                        assign product_variation_variants = product_variation_variants | where: option_index, current_variant[option_index]
                      endfor
                      assign color_out_of_stock = false
                      if product_variation_variants.size > 0
                        assign product_current_variation = product_variation_variants | first
                      else
                        assign color_out_of_stock = true
                      endif

                      assign variant_color_pv = product_variation.variants | where: option_color_position, pv_color_value | where: 'featured_image' | first
                      if variant_color_pv == nil
                        assign variant_color_pv = product_variation.variants | where: option_color_position, pv_color_value | first
                      endif

                      assign is_selected = false
                      if product_variation.id == product.id
                        assign is_selected = true
                      elsif product_variation.handle and product.handle and product_variation.handle == product.handle
                        assign is_selected = true
                      endif
                    -%}
                    <li>
                      <a
                        href="{% if color_out_of_stock %}#{% else %}{{ product_current_variation.url }}{% endif %}"
                        class="color-swatch-icon product-form__input__radio-label flex justify-center align-center por product-form__input__radio-label--color product-form__input__radio-label--color-{{ settings.color_swatches_shape }} bt-tooltip{% if color_out_of_stock %} no-stock{% endif %}"
                        data-color="{{ pv_color_value | handleize }}"
                        {% if is_selected %}style="border:0.2rem solid rgb(var(--color-highlight, var(--color-foreground)));"{% endif %}
                      >
                        <input
                          type="radio"
                          id="{{ section_id | default: section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                          name="{{ option.name }}{% if section_id %}-{{ section_id }}{% endif %}"
                          value="{{ pv_color_value | escape }}"
                          form="{{ product_form_id }}"
                          style="display:none"
                          {% if is_selected %}checked="checked"{% endif %}
                        >
                        {% render 'color-swatch',
                           color: pv_color_value,
                           variant_color: variant_color_pv,
                           color_swatches_style: block.settings.color_swatches_style,
                           card_product: product_current_variation,
                           link_url: product_current_variation.url %}
                        <span class="bt-tooltip__inner bt-tooltip__inner--top {% if color_out_of_stock %}d-none{% endif %}" style="z-index:10">
                          {{- product_current_variation.metafields.product_texts.title.value | default: product_current_variation.title -}}
                        </span>
                        {% if is_selected %}{% render 'icon-checkmark' %}{% endif %}
                        {% if color_out_of_stock %}{% render 'icon-close', add_classes: 'js-close-icon' %}{% else %}{% render 'icon-close', add_classes: 'js-close-icon d-none' %}{% endif %}
                      </a>
                    </li>
                  {%- endfor -%}

                  {%- assign in_group = false -%}
                  {%- for pv in variation_products -%}
                    {%- if pv and pv.id and pv.id == product.id -%}
                      {%- assign in_group = true -%}
                    {%- elsif pv and pv.handle and product.handle and pv.handle == product.handle -%}
                      {%- assign in_group = true -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- if in_group == false -%}
                    {%- assign attr_here = 'option' | append: option.position -%}
                    {%- assign value_here = option.selected_value -%}
                    {%- assign variants_for_color_here = product.variants | where: attr_here, value_here -%}
                    {%- assign variant_color_here = variants_for_color_here | where: 'featured_image' | first | default: variants_for_color_here.first -%}
                    <li>
                      <label
                        for="{{ section_id | default: section.id }}-{{ option.position }}-extra"
                        class="color-swatch-icon product-form__input__radio-label flex justify-center align-center por product-form__input__radio-label--color product-form__input__radio-label--color-{{ settings.color_swatches_shape }} bt-tooltip"
                        data-color="{{ value_here | handleize }}"
                      >
                        <input
                          type="radio"
                          id="{{ section_id | default: section.id }}-{{ option.position }}-extra"
                          name="{{ option.name }}{% if section_id %}-{{ section_id }}{% endif %}"
                          value="{{ value_here | escape }}"
                          form="{{ product_form_id }}"
                          checked="checked"
                        >
                        {% render 'color-swatch',
                           color: value_here,
                           variant_color: variant_color_here,
                           color_swatches_style: block.settings.color_swatches_style,
                           card_product: product %}
                        {% render 'icon-checkmark' %}
                      </label>
                    </li>
                  {%- endif -%}

                {%- else -%}
                  {%- assign attr_here = 'option' | append: option.position -%}
                  {%- for value2 in option.values -%}
                    {%- liquid
                      assign variants_for_color2 = product.variants | where: attr_here, value2
                      assign variant_color2 = variants_for_color2 | where: 'featured_image' | first
                      if variant_color2 == nil
                        assign variant_color2 = variants_for_color2 | first
                      endif

                      assign out_of_stock2 = false
                      if settings.hide_unavailable_options
                        unless instock_option_values contains value2
                          assign out_of_stock2 = true
                        endunless
                      elsif available_option_values contains value2
                        unless instock_option_values contains value2
                          assign out_of_stock2 = true
                        endunless
                      endif
                    -%}
                    <li class="variant-flex-item">
                      <input
                        type="radio"
                        id="{{ section_id | default: section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                        name="{{ option.name }}{% if section_id %}-{{ section_id }}{% endif %}"
                        class="product-form__input__radio{% unless settings.hide_unavailable_options %}{% unless available_option_values contains value2 %} disabled{% endunless %}{% endunless %}"
                        value="{{ value2 | escape }}"
                        form="{{ product_form_id }}"
                        {% if option.selected_value == value2 %}checked="checked"{% endif %}
                        {% if out_of_stock2 %}disabled="disabled"%{% endif %}
                      >
                      <label
                        for="{{ section_id | default: section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                        class="color-swatch-icon product-form__input__radio-label flex justify-center align-center por product-form__input__radio-label--color product-form__input__radio-label--color-{{ settings.color_swatches_shape }} bt-tooltip{% if out_of_stock2 %} soldout{% endif %}"
                        data-color="{{ value2 | handleize }}"
                      >
                        {% render 'color-swatch',
                           color: value2,
                           variant_color: variant_color2,
                           color_swatches_style: block.settings.color_swatches_style,
                           card_product: product %}
                        {% if option.selected_value == value2 %}{% render 'icon-checkmark' %}{% endif %}
                      </label>
                    </li>
                  {%- endfor -%}
                {%- endif -%}

              {%- else -%}
                <li
                  {% unless is_first_option %}
                    class="variant-flex-item dynamic-option{% if settings.hide_unavailable_options %}{% unless available_option_values contains value %} hidden{% endunless %}{% endif %}{% if forloop.index >= total_visible_items %} hidden-more{% endif %}"
                  {% else %}
                    class="variant-flex-item{% if forloop.index >= total_visible_items %} hidden-more{% endif %}"
                  {% endunless %}
                >
                  <input
                    type="radio"
                    id="{{ section_id | default: section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                    name="{{ option.name }}{% if section_id %}-{{ section_id }}{% endif %}"
                    class="product-form__input__radio{% unless settings.hide_unavailable_options %}{% unless available_option_values contains value %} disabled{% endunless %}{% endunless %}"
                    value="{{ value | escape }}"
                    form="{{ product_form_id }}"
                    {% assign variant2 = product.variants | where: index_option, value | first %}
                    data-desc="{{ variant2.metafields.product_texts.descriptionHtml.value | escape }}"
                    data-title="{{ variant2.metafields.product_texts.title.value | escape }}"
                    {% if option.selected_value == value %}checked="checked"%{% endif %}
                    {% if out_of_stock %}disabled="disabled"%{% endif %}
                  >
                  <label
                    for="{{ section_id | default: section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                    class="color-swatch-icon product-form__input__radio-label flex justify-center align-center por product-form__input__radio-label--pill font-body-semi-bold text-small{% if out_of_stock %} soldout{% endif %}"
                  >
                    {{ value }}
                  </label>
                </li>
              {%- endif -%}

              {% if forloop.index == total_visible_items %}
                <li class="variant-flex-item js-show-more">
                  <label
                    for="{{ section_id | default: section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                    class="product-form__input__radio-label flex justify-center align-center por {% if is_color_swatches %}product-form__input__radio-label--color product-form__input__radio-label--color-{{ settings.color_swatches_shape }} bt-tooltip{% if block.settings.color_swatches_style == 'variant' and variant_color != null %} color-swatch-own-image{% endif %}{% else %} product-form__input__radio-label--pill font-body-semi-bold text-small{% endif %}"
                  >
                    {{ 'products.product.show_more' | t }}
                  </label>
                </li>
              {% endif %}
            {%- endfor -%}
          </ul>
        </fieldset>

        <script type="application/json">
          {{ product.variants | json }}
        </script>
      </{{ prefix_variant }}variant-radios>
    {%- else -%}
      <{{ prefix_variant }}variant-selects
        class="no-js-hidden variant-picker-primary-{{ section.id }} db"
        data-section="{{ section.id }}"
        data-url="{{ product_url | default: product.url }}"
        {% if settings.hide_unavailable_options %}data-hide-unavailable-options="true"%{% endif %}
      >
        <div class="js-product-form-input product-form__input product-form__input--dropdown product-form__input--larger{% unless forloop.first %} element-small-margin-top{% endunless %}">
          <label class="form__label product-form__input__form-label" for="Option-{{ section_id | default: section.id }}-{{ forloop.index0 }}">
            {{ option.name | capitalize }}
          </label>
          <div class="select">
            <select
              id="Option-{{ section_id | default: section.id }}-{{ forloop.index0 }}"
              class="js-select-product select__select{% unless is_first_option %} dynamic-option{% endunless %} select__select-lower"
              name="options[{{ option.name | escape }}]"
              form="{{ product_form_id }}"
            >
              {%- liquid
                assign available_variants = product.variants
                unless settings.hide_unavailable_options
                  for available_option in product.options
                    if option.position != forloop.index
                      assign filter_index = 'option' | append: forloop.index
                      assign filter_value = first_selected_variant[filter_index]
                      assign available_variants = available_variants | where: filter_index, filter_value
                    endif
                  endfor
                else
                  if option.position > 1
                    assign end_compare_index = option.position | minus: 1
                    for i in (1..end_compare_index)
                      assign filter_index = 'option' | append: i
                      assign filter_value = first_selected_variant[filter_index]
                      assign available_variants = available_variants | where: filter_index, filter_value
                    endfor
                  endif
                endunless
                assign index_option = 'option' | append: option.position
                assign available_option_values = available_variants | map: indexOption
              -%}
              {%- for value in option.values -%}
                {%- liquid
                  assign is_first_option = forloop.first
                  assign variant = product.variants | where: index_option, value | first
                -%}
                <option
                  class="js-select-product-option"
                  value="{{ value | escape }}"
                  data-name="{{ option.name | escape }}"
                  {% if option.selected_value == value %}selected="selected"{% endif -%}
                  {% if settings.hide_unavailable_options and is_first_option == false %}
                    {%- unless available_option_values contains value %} class="hidden"{% endunless -%}
                  {% endif %}
                  data-desc="{{ variant.metafields.product_texts.descriptionHtml.value | escape }}"
                  data-title="{{ variant.metafields.product_texts.title.value | escape }}"
                >
                  {%- unless settings.hide_unavailable_options -%}
                    {%- if available_option_values contains value -%}
                      {{- value -}}
                    {%- else -%}
                      {{- 'products.product.value_unavailable' | t: option_value: value -}}
                    {%- endif -%}
                  {%- else -%}
                    {{ value }}
                  {%- endunless -%}
                </option>
              {%- endfor -%}
            </select>
            {% render 'icon-caret' %}
          </div>
        </div>

        <script type="application/json">
          {{ product.variants | json }}
        </script>
      </{{ prefix_variant }}variant-selects>
    {%- endif -%}
  {% endfor %}
{%- endunless -%}

<noscript class="product-form__noscript-wrapper-{{ section_id | default: section.id }}">
  <div class="product-form__input{% if product.has_only_default_variant %} hidden{% endif %}">
    <label class="form__label" for="Variants-{{ section_id | default: section.id }}">
      {{- 'products.product.product_variants' | t -}}
    </label>
    <div class="select">
      {% for option in product.options_with_values %}
        {% if option.name == 'default_option' and option.values.size == 1 %}
          {% continue %}
        {% endif %}
        <select
          name="options[{{ option.name | escape }}]"
          id="Option-{{ section_id | default: section.id }}-{{ forloop.index0 }}"
          class="select__select"
          form="{{ product_form_id }}"
        >
          {% for value in option.values %}
            <option value="{{ value | escape }}" {% if option.selected_value == value %}selected="selected"{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      {% endfor %}
      {% render 'icon-caret' %}
    </div>
  </div>
</noscript>