{%- comment -%}
  Card product badges – původní SALE/SOLD-OUT + nové custom labels z variant metafieldu fixed.labels
  - SALE a SOLD-OUT: beze změny (převzato z původního snippetu)
  - Custom labels: list.metaobject_reference na metaobjekt custom_data/lables (field: display_name)
  - Limit: max 4 badge (počítá se SALE + custom; SOLD-OUT se do limitu nepočítá)
  - Debug: ?debug_labels=1 (viditelný box + hluboká kontrola variant)
{%- endcomment -%}

{%- liquid
  assign custom_badges = ''
  assign total = 0
  assign index_badge_position = 1

  assign sale_active = 'false'
  if card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none'
    assign sale_active = 'true'
    assign total = total | plus: 1
    assign index_badge_position = 2
  endif

  assign variant_obj = card_product.selected_or_first_available_variant
  if variant_obj == nil
    assign variant_obj = card_product.variants | first
  endif

  assign LABELS_NS = 'fixed'
  assign LABELS_KEY = 'lables'

  assign labels_mf = variant_obj.metafields[LABELS_NS][LABELS_KEY]
-%}

{%- comment -%} CUSTOM LABELS (nová logika) {%- endcomment -%}
{%- if labels_mf and labels_mf.value != blank -%}
  {%- for label in labels_mf.value -%}
    {%- if total >= 4 -%}{% break %}{%- endif -%}
    {%- assign label_text = label.display_name | default: '' | strip -%}
    {%- if label_text != '' -%}
      {%- capture custom_badges -%}
        {{ custom_badges }}
<span
  class="badge badge--bottom-left badge--custom badge--position-{{ index_badge_position }} badge--{{ label.key | downcase }} font-body-bold"
  data-badge="custom_label"
  data-product-id="{{ card_product.id }}"
  data-variant-id="{{ variant_obj.id }}"
  data-label-key="{{ label.key | escape }}"
>
  {{ label_text }}
</span>
      {%- endcapture -%}
      {%- assign total = total | plus: 1 -%}
      {%- assign index_badge_position = index_badge_position | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- if total > 0 or card_product.available == false -%}

  {%- comment -%} SALE badge (původní, beze změny) {%- endcomment -%}
  {%- if card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none' -%}
    <span id="{{ prefix_id }}-{{ section_id }}-{{ card_product.id }}" class="badge badge--bottom-left badge--sale badge--position-1 font-body-bold">
      {%- if settings.sale_badge_label == 'text' -%}
        {{ 'products.product.on_sale' | t }}
      {%- elsif settings.sale_badge_label == 'percent' -%}
        {{ card_product.price | minus: card_product.compare_at_price | times: 100.00 | divided_by: card_product.compare_at_price | round }}%
      {%- else -%}
        {%- if settings.currency_code_enabled -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money_with_currency }}
        {%- else -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money }}
        {%- endif -%}
      {%- endif -%}
    </span>
  {%- endif -%}

  {%- comment -%} SOLD OUT badge (původní, beze změny) {%- endcomment -%}
  {%- if card_product.available == false -%}
    <span id="{{ prefix_id }}-{{ section_id }}-{{ card_product.id }}" class="badge badge--bottom-left badge--sold-out uppercase {% if card_product.compare_at_price > card_product.price and card_product.available %}badge--position-2{% else %}badge--position-1{% endif %} font-body-bold">
      {{ 'products.product.sold_out' | t }}
    </span>
  {%- endif -%}

  {{ custom_badges }}

{%- endif -%}
<style>
.badge--new {
    --color-badge-foreground: var(--color-custom-badge-1-foreground);
    --color-badge-background: var(--color-custom-badge-1-background);
}
.badge--bestseller {
    --color-badge-foreground: var(--color-custom-badge-4-foreground);
    --color-badge-background: var(--color-custom-badge-4-background);
}
</style>