{%- comment -%}
  Card product badges – původní SALE/SOLD-OUT + nové custom labels z variant metafieldu fixed.labels
  - SALE a SOLD-OUT: beze změny (převzato z původního snippetu)
  - Custom labels: list.metaobject_reference na metaobjekt custom_data/lables (field: display_name)
  - Limit: max 4 badge (počítá se SALE + custom; SOLD-OUT se do limitu nepočítá)
  - Debug: ?debug_labels=1 (viditelný box + hluboká kontrola variant)
{%- endcomment -%}

{%- liquid
  assign custom_badges = ''
  assign total = 0
  assign index_badge_position = 1

  assign sale_active = 'false'
  if card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none'
    assign sale_active = 'true'
    assign total = total | plus: 1
    assign index_badge_position = 2
  endif

  assign variant_obj = card_product.selected_or_first_available_variant
  if variant_obj == nil
    assign variant_obj = card_product.variants | first
  endif

  assign LABELS_NS = 'fixed'
  assign LABELS_KEY = 'lables'

  assign labels_mf = variant_obj.metafields[LABELS_NS][LABELS_KEY]
-%}

{%- comment -%} CUSTOM LABELS (nová logika) {%- endcomment -%}
{%- if labels_mf and labels_mf.value != blank -%}
  {%- for label in labels_mf.value -%}
    {%- if total >= 4 -%}{% break %}{%- endif -%}
    {%- assign label_text = label.display_name | default: '' | strip -%}
    {%- if label_text != '' -%}
      {%- capture custom_badges -%}
        {{ custom_badges }}
        <span
          class="badge badge--bottom-left badge--custom badge--position-{{ index_badge_position }} font-body-bold"
          data-badge="custom_label"
          data-product-id="{{ card_product.id }}"
          data-variant-id="{{ variant_obj.id }}"
          {%- if label.key != blank -%} data-label-key="{{ label.key | escape }}"{%- endif -%}
          {%- if label.handle != blank -%} data-label-handle="{{ label.handle | escape }}"{%- endif -%}
        >{{ label_text }}</span>
      {%- endcapture -%}
      {%- assign total = total | plus: 1 -%}
      {%- assign index_badge_position = index_badge_position | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- if total > 0 or card_product.available == false -%}

  {%- comment -%} SALE badge (původní, beze změny) {%- endcomment -%}
  {%- if card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none' -%}
    <span id="{{ prefix_id }}-{{ section_id }}-{{ card_product.id }}" class="badge badge--bottom-left badge--sale badge--position-1 font-body-bold">
      {%- if settings.sale_badge_label == 'text' -%}
        {{ 'products.product.on_sale' | t }}
      {%- elsif settings.sale_badge_label == 'percent' -%}
        {{ card_product.price | minus: card_product.compare_at_price | times: 100.00 | divided_by: card_product.compare_at_price | round }}%
      {%- else -%}
        {%- if settings.currency_code_enabled -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money_with_currency }}
        {%- else -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money }}
        {%- endif -%}
      {%- endif -%}
    </span>
  {%- endif -%}

  {%- comment -%} SOLD OUT badge (původní, beze změny) {%- endcomment -%}
  {%- if card_product.available == false -%}
    <span id="{{ prefix_id }}-{{ section_id }}-{{ card_product.id }}" class="badge badge--bottom-left badge--sold-out uppercase {% if card_product.compare_at_price > card_product.price and card_product.available %}badge--position-2{% else %}badge--position-1{% endif %} font-body-bold">
      {{ 'products.product.sold_out' | t }}
    </span>
  {%- endif -%}

  {{ custom_badges }}

{%- endif -%}


  {%- assign sel_has_labels = 'false' -%}
  {%- assign sel_has_lables = 'false' -%}
  {%- if variant_obj.metafields.fixed.labels != blank -%}{% assign sel_has_labels = 'true' %}{%- endif -%}
  {%- if variant_obj.metafields.fixed.lables != blank -%}{% assign sel_has_lables = 'true' %}{%- endif -%}

  <div style="margin-top:.5rem;padding:.5rem;border:1px dashed #888;font:12px/1.5 system-ui;background:#fff">
    <strong>DEBUG labels</strong><br>
    product_id: {{ card_product.id }}<br>
    variant_id: {{ variant_obj.id }}<br>
    sale_active: {{ sale_active }}<br>
    available: {{ card_product.available }}<br>
    total_rendered (sale+custom, bez sold-out limitu): {{ total }}<br>
    metafield_used: {% if sel_has_labels == 'true' %}fixed.labels{% else %}<em>none</em>{% endif %}<br>
    <div style="margin-top:.4rem"><u>Selected variant → fixed.* přehled:</u></div>
    <div style="font-family:monospace;white-space:pre-wrap;margin:.2rem 0 .5rem">
      fixed.labels present: {{ sel_has_labels }}<br>
      fixed.lables present (typo, jen debug): {{ sel_has_lables }}
    </div>

    {%- if variant_obj.metafields.fixed.labels and variant_obj.metafields.fixed.labels.value != blank -%}
      <div><u>Selected variant → fixed.labels items ({{ variant_obj.metafields.fixed.labels.value.size }}):</u></div>
      <ul style="margin:.25rem 0 0;padding-left:1rem">
        {%- for label in variant_obj.metafields.fixed.labels.value -%}
          <li>#{{ forloop.index }} — handle: {{ label.handle }} | display_name: {{ label.display_name | escape }} | key: {{ label.key | escape }}</li>
        {%- endfor -%}
      </ul>
    {%- else -%}
      <em>Selected variant nemá nic ve fixed.labels.</em>
    {%- endif -%}

    <hr style="border:none;border-top:1px dotted #ccc;margin:.6rem 0">
    <div><u>Kontrola všech variant produktu (kde je něco ve fixed.labels):</u></div>
    <ul style="margin:.25rem 0 0;padding-left:1rem">
      {%- for v in card_product.variants -%}
        {%- assign v_has_labels = 'false' -%}
        {%- assign v_has_labels_count = 0 -%}
        {%- if v.metafields.fixed.labels and v.metafields.fixed.labels.value != blank -%}
          {%- assign v_has_labels = 'true' -%}
          {%- assign v_has_labels_count = v.metafields.fixed.labels.value.size -%}
        {%- endif -%}
        {%- assign v_has_lables = 'false' -%}
        {%- if v.metafields.fixed.lables != blank -%}{% assign v_has_lables = 'true' %}{%- endif -%}

        <li>
          variant_id {{ v.id }} —
          labels? {{ v_has_labels }}{% if v_has_labels == 'true' %} ({{ v_has_labels_count }}){% endif %}
          {% if v_has_lables == 'true' %} | <em>lables? true (překlep)</em>{% endif %}
          {%- if v_has_labels == 'true' -%}
            <ul style="margin:.15rem 0 0;padding-left:1rem">
              {%- for lbl in v.metafields.fixed.labels.value -%}
                <li>• {{ lbl.display_name | escape }}{% if lbl.key != blank %} (key: {{ lbl.key | escape }}){% endif %}</li>
              {%- endfor -%}
            </ul>
          {%- endif -%}
        </li>
      {%- endfor -%}
    </ul>
  </div>
