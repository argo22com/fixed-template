{%- comment -%}
	Renders badges in a card product

	Accepts:
	- card_product: {Object} Product Liquid object (optional)
	- section_id: {String} The ID of the section that contains this card.
	- prefix_id: {String} The prefix that used to print in the HTML ID. Not apply the prefix ID for custom badges.
	
	Usage:
	{% render 'card-product-badges', card_product: product %}
{%- endcomment -%}
{%- liquid
  assign total = 0
  assign index_badge_position = 1
  assign out = ''
  assign variant_obj = card_product.selected_or_first_available_variant
  if variant_obj == nil
    assign variant_obj = card_product.variants | first
  endif
-%}

{%- capture badges_out -%}
  {%- comment %} SALE badge (původní tvorba) {% endcomment -%}
  {%- if card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none' -%}
    <span
      class="badge badge--bottom-left badge--sale badge--position-1 font-body-bold"
      data-badge="sale"
      data-product-id="{{ card_product.id }}"
      data-variant-id="{{ variant_obj.id }}"
    >
      {%- if settings.sale_badge_label == 'text' -%}
        {{ 'products.product.on_sale' | t }}
      {%- elsif settings.sale_badge_label == 'percent' -%}
        {{ card_product.compare_at_price | minus: card_product.price | times: 100.0 | divided_by: card_product.compare_at_price | round }}%
      {%- else -%}
        {%- if settings.currency_code_enabled -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money_with_currency }}
        {%- else -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money }}
        {%- endif -%}
      {%- endif -%}
    </span>
    {%- assign total = total | plus: 1 -%}
    {%- assign index_badge_position = 2 -%}
  {%- endif -%}

  {%- comment %} SOLD OUT badge (původní tvorba) {% endcomment -%}
  {%- if card_product.available == false and total < 4 -%}
    <span
      class="badge badge--bottom-left badge--sold-out uppercase badge--position-{{ index_badge_position }} font-body-bold"
      data-badge="sold_out"
      data-product-id="{{ card_product.id }}"
      data-variant-id="{{ variant_obj.id }}"
    >
      {{ 'products.product.sold_out' | t }}
    </span>
    {%- assign total = total | plus: 1 -%}
    {%- assign index_badge_position = index_badge_position | plus: 1 -%}
  {%- endif -%}

  {%- comment %} CUSTOM LABELS z varianty: fixed.labels (list.metaobject_reference) {% endcomment -%}
  {%- assign labels_mf = variant_obj.metafields.fixed.labels -%}
  {%- if labels_mf and labels_mf.value != blank -%}
    {%- for label in labels_mf.value -%}
      {%- if total >= 4 -%}{% break %}{%- endif -%}
      {%- assign label_text = label.display_name | default: '' | strip -%}
      {%- if label_text != '' -%}
        <span
          class="badge badge--bottom-left badge--custom-label badge--position-{{ index_badge_position }} font-body-bold"
          data-badge="custom_label"
          data-product-id="{{ card_product.id }}"
          data-variant-id="{{ variant_obj.id }}"
          {%- if label.key != blank -%} data-label-key="{{ label.key | escape }}"{%- endif -%}
          {%- if label.handle != blank -%} data-label-handle="{{ label.handle | escape }}"{%- endif -%}
          {%- if label.type != blank -%} data-label-type="{{ label.type | escape }}"{%- endif -%}
        >{{ label_text }}</span>
        {%- assign total = total | plus: 1 -%}
        {%- assign index_badge_position = index_badge_position | plus: 1 -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endcapture -%}

{%- if badges_out != blank -%}
  {{ badges_out }}
{%- endif -%}

{%- comment -%}
  Debug: ?debug_labels=1
{%- endcomment -%}
{%- assign __dbg = request.params.debug_labels | downcase -%}
{%- if __dbg == '1' or __dbg == 'true' -%}
  <!-- DEBUG labels
  product_id: {{ card_product.id }}
  variant_id: {{ variant_obj.id }}
  sale_active: {{ card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none' }}
  available: {{ card_product.available }}
  total_rendered: {{ total }}
  metafield_used: {% if variant_obj.metafields.fixed.labels != blank %}fixed.labels{% else %}none{% endif %}
  {% if labels_mf and labels_mf.value %}
    items:
    {% for label in labels_mf.value %}
      - idx: {{ forloop.index }}
        handle: {{ label.handle }}
        display_name: {{ label.display_name | json }}
        key: {{ label.key | json }}
        type: {{ label.type }}
    {% endfor %}
  {% endif %}
  -->
{%- endif -%}