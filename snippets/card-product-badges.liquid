{%- comment -%}
  Card product badges – původní SALE/SOLD-OUT + nové custom labels z variant metafieldu fixed.labels
  - SALE a SOLD-OUT: beze změny (převzato z původního snippetu)
  - Custom labels: list.metaobject_reference na metaobjekt custom_data/lables (field: display_name)
  - Limit: max 4 badge (počítá se SALE + custom; SOLD-OUT se do limitu nepočítá)
{%- endcomment -%}

{%- liquid
  assign custom_badges = ''
  assign total = 0
  assign index_badge_position = 1

  assign sale_active = 'false'
  if card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none'
    assign sale_active = 'true'
    assign total = total | plus: 1
    assign index_badge_position = 2
  endif

  assign variant_obj = card_product.selected_or_first_available_variant
  if variant_obj == nil
    assign variant_obj = card_product.variants | first
  endif

  assign LABELS_NS = 'labels'
  assign LABELS_KEY = 'key'
  assign labels_mf = variant_obj.metafields[LABELS_NS][LABELS_KEY]

  # Aktuální čas jako timestamp
  assign now_ts = 'now' | date: '%s'

  # JSON s platností labelů – nejdřív varianta, pak fallback na produkt
  assign validity_raw = variant_obj.metafields.labels.metadata
  if validity_raw == blank
    assign validity_raw = card_product.metafields.labels.metadata
  endif

  if validity_raw != blank
    assign label_validity = validity_raw | parse_json
  else
    assign label_validity = nil
  endif
-%}

{%- comment -%} CUSTOM LABELS s kontrolou platnosti {%- endcomment -%}
{%- if labels_mf and labels_mf.value != blank -%}
  {%- for label in labels_mf.value -%}
    {%- if total >= 4 -%}{% break %}{%- endif -%}

    {%- assign label_text = label.display_name | default: '' | strip -%}
    {%- assign label_key  = label.key | default: '' | strip -%}
    {%- assign show_label = true -%}

    {%- comment -%}
      Pokud máme JSON label_validity a label_key není prázdný:
      - najdeme pravidlo pro daný key
      - pokud existuje, porovnáme validFrom / validTo s now_ts
    {%- endcomment -%}
    {%- if label_validity and label_key != '' -%}
      {%- assign rule = label_validity[label_key] -%}
      {%- if rule -%}
        {%- if rule.validFrom != blank -%}
          {%- assign from_ts = rule.validFrom | date: '%s' -%}
          {%- if now_ts < from_ts -%}
            {%- assign show_label = false -%}
          {%- endif -%}
        {%- endif -%}

        {%- if rule.validTo != blank and show_label -%}
          {%- assign to_ts = rule.validTo | date: '%s' -%}
          {%- if now_ts > to_ts -%}
            {%- assign show_label = false -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}

    {%- if show_label and label_text != '' -%}
      {%- capture custom_badges -%}
        {{ custom_badges }}
<span
  class="badge badge--bottom-left badge--custom badge--position-{{ index_badge_position }} badge--{{ label_key | downcase }} font-body-bold"
  data-badge="custom_label"
  data-product-id="{{ card_product.id }}"
  data-variant-id="{{ variant_obj.id }}"
  data-label-key="{{ label_key | escape }}"
>
  {{ label_text }}
</span>
      {%- endcapture -%}
      {%- assign total = total | plus: 1 -%}
      {%- assign index_badge_position = index_badge_position | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- if total > 0 or card_product.available == false -%}

  {%- comment -%} SALE badge (původní, beze změny) {%- endcomment -%}
  {%- if card_product.compare_at_price > card_product.price and card_product.available and settings.sale_badge_label != 'none' -%}
    <span id="{{ prefix_id }}-{{ section_id }}-{{ card_product.id }}" class="badge badge--bottom-left badge--sale badge--position-1 font-body-bold">
      {%- if settings.sale_badge_label == 'text' -%}
        {{ 'products.product.on_sale' | t }}
      {%- elsif settings.sale_badge_label == 'percent' -%}
        {{ card_product.price | minus: card_product.compare_at_price | times: 100.00 | divided_by: card_product.compare_at_price | round }}%
      {%- else -%}
        {%- if settings.currency_code_enabled -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money_with_currency }}
        {%- else -%}
          -{{ card_product.compare_at_price | minus: card_product.price | money }}
        {%- endif -%}
      {%- endif -%}
    </span>
  {%- endif -%}

  {%- comment -%} SOLD OUT badge (původní, beze změny) {%- endcomment -%}
  {%- if card_product.available == false -%}
    <span id="{{ prefix_id }}-{{ section_id }}-{{ card_product.id }}" class="badge badge--bottom-left badge--sold-out uppercase {% if card_product.compare_at_price > card_product.price and card_product.available %}badge--position-2{% else %}badge--position-1{% endif %} font-body-bold">
      {{ 'products.product.sold_out' | t }}
    </span>
  {%- endif -%}

  {{ custom_badges }}

{%- endif -%}

<style>
.badge--custom {
    --color-badge-foreground: var(--color-custom-badge-4-foreground);
    --color-badge-background: var(--color-custom-badge-4-background);
}  
.badge--custom.badge--new {
    --color-badge-foreground: var(--color-custom-badge-2-foreground);
    --color-badge-background: var(--color-custom-badge-2-background);
}
.badge--custom.badge--bestseller {
    --color-badge-foreground: var(--color-custom-badge-3-foreground);
    --color-badge-background: var(--color-custom-badge-3-background);
}
.badge--custom.badge--laststock {
    --color-badge-foreground: var(--color-custom-badge-1-foreground);
    --color-badge-background: var(--color-custom-badge-1-background);
}
</style>